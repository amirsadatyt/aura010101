<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <title>Sadat Digital Banknote (Falcon-512 + SHAKE256)</title>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
Â  Â  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
Â  Â  <script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="onOpenCvReady();"></script>

Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-font: 'Poppins', 'Segoe UI', sans-serif;
Â  Â  Â  Â  Â  Â  --mono-font: 'Roboto Mono', monospace;
Â  Â  Â  Â  Â  Â  --dark-bg: #10101a;
Â  Â  Â  Â  Â  Â  --medium-bg: #1a1a2e;
Â  Â  Â  Â  Â  Â  --light-bg: #2a2a3e;
Â  Â  Â  Â  Â  Â  --accent-color-1: #e040fb;
Â  Â  Â  Â  Â  Â  --accent-color-2: #7c4dff;
Â  Â  Â  Â  Â  Â  --text-color: #e0e0e0;
Â  Â  Â  Â  Â  Â  --text-muted: #a0a0c0;
Â  Â  Â  Â  Â  Â  --success-color: #00e676;
Â  Â  Â  Â  Â  Â  --error-color: #ff5252;
Â  Â  Â  Â  Â  Â  --info-color: #40c4ff;
Â  Â  Â  Â  Â  Â  --border-color: rgba(124, 77, 255, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font-family: var(--primary-font);
Â  Â  Â  Â  Â  Â  background-color: var(--dark-bg);
Â  Â  Â  Â  Â  Â  background-image:
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(at 0% 0%, hsla(253, 100%, 15%, 0.3) 0px, transparent 50%),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(at 100% 100%, hsla(263, 100%, 20%, 0.3) 0px, transparent 50%);
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  padding: 24px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  max-width: 900px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  background: rgba(26, 26, 46, 0.7);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(12px);
Â  Â  Â  Â  Â  Â  padding: 24px;
Â  Â  Â  Â  Â  Â  border-radius: 24px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  padding-bottom: 16px;
Â  Â  Â  Â  Â  Â  margin-bottom: 24px;
Â  Â  Â  Â  }

Â  Â  Â  Â  h1 {
Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  margin: 0 0 8px 0;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2));
Â  Â  Â  Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header p {
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  color: var(--text-muted);
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  canvas {
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  margin-top: 24px;
Â  Â  Â  Â  Â  Â  background: #050508;
Â  Â  Â  Â  Â  Â  cursor: default;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 50px rgba(124, 77, 255, 0.15);
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 900px;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  input[type="number"], input[type="text"], textarea, button, label {
Â  Â  Â  Â  Â  Â  padding: 14px 22px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-family: var(--primary-font);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  margin: 8px 5px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  background: var(--medium-bg);
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  input[type="number"], input[type="text"], textarea {
Â  Â  Â  Â  Â  Â  font-family: var(--mono-font);
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  width: 150px;
Â  Â  Â  Â  }
Â  Â  Â  Â  textarea {
Â  Â  Â  Â  Â  Â  min-height: 100px;
Â  Â  Â  Â  Â  Â  width: calc(100% - 20px);
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  }

Â  Â  Â  Â  input[type="number"]:focus, input[type="text"]:focus, textarea:focus {
Â  Â  Â  Â  Â  Â  border-color: var(--accent-color-2);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(124, 77, 255, 0.5);
Â  Â  Â  Â  }

Â  Â  Â  Â  button:not([disabled]), label:not([disabled]) {
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, var(--accent-color-1), var(--accent-color-2));
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  button.sub-button, label.sub-button {
Â  Â  Â  Â  Â  Â  background: var(--light-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  button[disabled], label[disabled] {
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  Â  Â  opacity: 0.5;
Â  Â  Â  Â  Â  Â  background: var(--light-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  button.sub-button:hover:not([disabled]), label.sub-button:hover:not([disabled]) {
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  Â  }

Â  Â  Â  Â  button:hover:not([disabled]), label:hover:not([disabled]) {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(124, 77, 255, 0.4);
Â  Â  Â  Â  }

Â  Â  Â  Â  .section {
Â  Â  Â  Â  Â  Â  background: rgba(16, 16, 26, 0.5);
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  h2 {
Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .controls-grid {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #validation-result, #key-status {
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  Â  Â  min-height: 50px;
Â  Â  Â  Â  Â  Â  line-height: 1.6;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  background: var(--dark-bg);
Â  Â  Â  Â  Â  Â  padding: 15px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  white-space: pre-wrap;
Â  Â  Â  Â  Â  Â  font-family: var(--mono-font);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .valid { color: var(--success-color); }
Â  Â  Â  Â  .invalid { color: var(--error-color); }
Â  Â  Â  Â  .info { color: var(--info-color); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .key-info {
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .key-info p {
Â  Â  Â  Â  Â  Â  margin: 5px 0;
Â  Â  Â  Â  Â  Â  color: var(--text-muted);
Â  Â  Â  Â  }
Â  Â  Â  Â  .key-info code {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  Â  Â  word-break: break-all;
Â  Â  Â  Â  Â  Â  background: var(--light-bg);
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-heading {
Â  Â  Â  Â  Â  Â  color: var(--accent-color-1);
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  padding-bottom: 6px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  font-family: var(--primary-font);
Â  Â  Â  Â  }

Â  Â  Â  Â  .comparison-item {
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  padding: 8px 10px;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  border-left: 3px solid var(--accent-color-2);
Â  Â  Â  Â  }
Â  Â  Â  Â  code {
Â  Â  Â  Â  Â  Â  background: var(--medium-bg);
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-label {
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  color: var(--text-muted);
Â  Â  Â  Â  Â  Â  margin-right: -10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .upload-container {
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
<div class="container">
Â  Â  <div class="header">
Â  Â  Â  Â  <h1>Sadat Digital Banknote</h1>
Â  Â  Â  Â  <p>A proof-of-concept for a secure digital banknote using Falcon-512 and SHAKE256.</p>
Â  Â  </div>

Â  Â  <canvas id="noteCanvas" width="1350" height="750"></canvas>

Â  Â  <div class="section">
Â  Â  Â  Â  <h2>Banknote Controls</h2>
Â  Â  Â  Â  <div class="controls-grid">
Â  Â  Â  Â  Â  Â  <span class="input-label">Amount:</span>
Â  Â  Â  Â  Â  Â  <input type="number" id="amount-input" value="50000">
Â  Â  Â  Â  Â  Â  <span class="input-label">Quantity:</span>
Â  Â  Â  Â  Â  Â  <input type="number" id="quantity-input" value="1" min="1" max="100">
Â  Â  Â  Â  Â  Â  <button id="create-note-button" disabled>ğŸ¨ Redesign Note</button>
Â  Â  Â  Â  Â  Â  <button id="download-batch-button" disabled>ğŸ“¥ Download Batch</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="section">
Â  Â  Â  Â  <h2>Bank Key Management</h2>
Â  Â  Â  Â  <div class="controls-grid">
Â  Â  Â  Â  Â  Â  <button id="generate-keys-button">ğŸ”‘ Generate & Export Keys</button>
Â  Â  Â  Â  Â  Â  <label for="import-public-key" class="sub-button">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Import Public Key
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <input type="file" id="import-public-key" accept=".json" style="display: none;">
Â  Â  Â  Â  Â  Â  <label for="import-private-key" class="sub-button">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Import Private Key
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <input type="file" id="import-private-key" accept=".json" style="display: none;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="key-status">Key status will be shown here.</div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="section">
Â  Â  Â  Â  <h2>Banknote Validation</h2>
Â  Â  Â  Â  <div class="controls-grid">
Â  Â  Â  Â  Â  Â  <label for="verify-from-image" class="sub-button">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Upload Image to Verify
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <input type="file" id="verify-from-image" accept="image/*" style="display: none;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <hr style="border-color: rgba(124, 77, 255, 0.1); margin: 20px 0;">
Â  Â  Â  Â  <p style="color: var(--text-muted); margin-bottom: 10px;">Or enter banknote details manually:</p>
Â  Â  Â  Â  <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
Â  Â  Â  Â  Â  Â  <div class="controls-grid" style="width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="input-label">Amount:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="verify-amount">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="input-label">Serial:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="verify-serial">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="input-label">Verification Key:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="verify-verification-key">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <textarea id="verify-signature" placeholder="Base64 Digital Signature..." style="min-height: 120px;"></textarea>
Â  Â  Â  Â  Â  Â  <button id="verify-note-button" disabled>âœ… Verify Authenticity</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="validation-result" style="text-align: center;">Validation result will be shown here.</div>
Â  Â  </div>
</div>

<script type="module">
// --- IMPORTANT SECURITY NOTE ---
// This code is a proof-of-concept for a digital banknote.
// All cryptographic operations are performed in the browser (client-side).
// For a real-world banking system, the private key MUST be managed in a secure, isolated environment (like an HSM)
// on the server side to protect against attacks and prevent double-spending.

// Import cryptographic libraries as modules
import pqcSignFalcon512 from './falcon.js';
import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

/**
Â * The SadatBanknoteApp class manages all application logic and UI.
Â * It's structured this way for better organization and maintainability.
Â */
class SadatBanknoteApp {
Â  Â  constructor() {
Â  Â  Â  Â  this.canvas = document.getElementById("noteCanvas");
Â  Â  Â  Â  this.ctx = this.canvas.getContext("2d");
Â  Â  Â  Â  this.falconApi = null;
Â  Â  Â  Â  this.activeKeys = { publicKey: null, privateKey: null };
Â  Â  Â  Â  this.isOpenCvReady = false;

Â  Â  Â  Â  // Bind event handlers to the class instance
Â  Â  Â  Â  this.initEventListeners();
Â  Â  }

Â  Â  /**
Â  Â  Â * Helper methods for data conversion
Â  Â  Â */
Â  Â  arrayBufferToBase64 = (buffer) => btoa(String.fromCharCode(...new Uint8Array(buffer)));
Â  Â  base64ToUint8Array = (base64) => {
Â  Â  Â  Â  const binary_string = window.atob(base64);
Â  Â  Â  Â  const len = binary_string.length;
Â  Â  Â  Â  const bytes = new Uint8Array(len);
Â  Â  Â  Â  for (let i = 0; i < len; i++) {
Â  Â  Â  Â  Â  Â  bytes[i] = binary_string.charCodeAt(i);
Â  Â  Â  Â  }
Â  Â  Â  Â  return bytes;
Â  Â  };
Â  Â  uint8ArrayToHex = (bytes) => Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
Â  Â  hexToUint8Array = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

Â  Â  /**
Â  Â  Â * UI state management
Â  Â  Â */
Â  Â  updateKeyStatus(message) {
Â  Â  Â  Â  document.getElementById('key-status').innerHTML = message;
Â  Â  }

Â  Â  updateValidationResult(message) {
Â  Â  Â  Â  document.getElementById('validation-result').innerHTML = message;
Â  Â  }

Â  Â  updateControlsState(hasPrivateKey, hasPublicKey) {
Â  Â  Â  Â  document.getElementById('create-note-button').disabled = !hasPrivateKey;
Â  Â  Â  Â  document.getElementById('download-batch-button').disabled = !hasPrivateKey;
Â  Â  Â  Â  document.getElementById('verify-note-button').disabled = !hasPublicKey;
Â  Â  Â  Â  document.getElementById('verify-from-image').disabled = !hasPublicKey;
Â  Â  }

Â  Â  /**
Â  Â  Â * UI event handlers
Â  Â  Â */
Â  Â  initEventListeners() {
Â  Â  Â  Â  document.getElementById('generate-keys-button').addEventListener('click', () => this.handleGenerateAndExportKeys());
Â  Â  Â  Â  document.getElementById('create-note-button').addEventListener('click', () => this.handleCreateNewNote());
Â  Â  Â  Â  document.getElementById('download-batch-button').addEventListener('click', () => this.handleDownloadBatch());
Â  Â  Â  Â  document.getElementById('import-public-key').addEventListener('change', (e) => this.handleImportPublicKey(e));
Â  Â  Â  Â  document.getElementById('import-private-key').addEventListener('change', (e) => this.handleImportPrivateKey(e));
Â  Â  Â  Â  document.getElementById('verify-note-button').addEventListener('click', () => this.handleVerifyNoteManually());
Â  Â  Â  Â  document.getElementById('verify-from-image').addEventListener('change', (e) => this.handleVerifyFromImage(e));
Â  Â  }

Â  Â  /**
Â  Â  Â * App initialization and cryptographic module loading
Â  Â  Â */
Â  Â  async init() {
Â  Â  Â  Â  this.updateControlsState(false, false);
Â  Â  Â  Â  this.updateKeyStatus('<span class="info">â³ Loading Falcon-512 cryptographic module...</span>');
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  this.falconApi = await pqcSignFalcon512();
Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="info">âœ… Falcon-512 module loaded. Waiting for OpenCV.js...</span>');
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Failed to load Falcon module:", e);
Â  Â  Â  Â  Â  Â  this.updateKeyStatus(`<span class="invalid">âŒ CRITICAL ERROR: Failed to load Falcon-512 module. ${e.message}</span>`);
Â  Â  Â  Â  Â  Â  alert("Error: Cryptographic module failed to load.");
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  onOpenCvReady() {
Â  Â  Â  Â  this.isOpenCvReady = true;
Â  Â  Â  Â  this.updateKeyStatus('<span class="info">âœ… All modules ready. Please generate or import keys.</span>');
Â  Â  Â  Â  this.updateControlsState(!!this.activeKeys.privateKey, !!this.activeKeys.publicKey);
Â  Â  }

Â  Â  // =================================================================
Â  Â  // Cryptography and Key Management
Â  Â  // =================================================================
Â  Â Â 
Â  Â  /**
Â  Â  Â * Uses SHAKE256 to create a 1024-bit hash of the message.
Â  Â  Â */
Â  Â  hashMessage(message) {
Â  Â  Â  Â  const hexHash = shake256(message, 1024);
Â  Â  Â  Â  return this.hexToUint8Array(hexHash);
Â  Â  }

Â  Â  /**
Â  Â  Â * Signs data using the Falcon-512 private key.
Â  Â  Â */
Â  Â  async signData(data, privateKey) {
Â  Â  Â  Â  if (!this.falconApi) throw new Error("Falcon API is not initialized.");
Â  Â  Â  Â  const dataHash = this.hashMessage(data);
Â  Â  Â  Â  const { signature } = await this.falconApi.sign(dataHash, privateKey);
Â  Â  Â  Â  return signature;
Â  Â  }

Â  Â  /**
Â  Â  Â * Verifies a signature using the Falcon-512 public key.
Â  Â  Â */
Â  Â  async verifySignature(data, signature, publicKey) {
Â  Â  Â  Â  if (!this.falconApi) throw new Error("Falcon API is not initialized.");
Â  Â  Â  Â  const dataHash = this.hashMessage(data);
Â  Â  Â  Â  return await this.falconApi.verify(dataHash, signature, publicKey);
Â  Â  }

Â  Â  /**
Â  Â  Â * Standardizes banknote data for signing.
Â  Â  Â */
Â  Â  getStandardizedDataForSigning(noteData) {
Â  Â  Â  Â  const dataToSign = {
Â  Â  Â  Â  Â  Â  amount: parseInt(noteData.amount),
Â  Â  Â  Â  Â  Â  serial: noteData.serial,
Â  Â  Â  Â  Â  Â  timestamp: parseInt(noteData.timestamp),
Â  Â  Â  Â  Â  Â  verificationKey: noteData.verificationKey
Â  Â  Â  Â  };
Â  Â  Â  Â  return JSON.stringify(dataToSign, Object.keys(dataToSign).sort());
Â  Â  }
Â  Â Â 
Â  Â  // =================================================================
Â  Â  // Key Management
Â  Â  // =================================================================
Â  Â  async handleGenerateAndExportKeys() {
Â  Â  Â  Â  const password = prompt("Enter a strong password to encrypt your private key file:");
Â  Â  Â  Â  if (!password) {
Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="invalid">âŒ Operation cancelled. Password is required.</span>');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  this.updateKeyStatus('<span class="info">â³ Generating Falcon-512 key pair and encrypting... Please wait.</span>');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const keyPair = await this.falconApi.keypair();
Â  Â  Â  Â  Â  Â  this.activeKeys.publicKey = keyPair.publicKey;
Â  Â  Â  Â  Â  Â  this.activeKeys.privateKey = keyPair.privateKey;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  this.downloadFile(JSON.stringify({ keyData: this.arrayBufferToBase64(keyPair.publicKey) }, null, 2), 'Sadat-Falcon-public-key.json', 'application/json');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const encryptedPrivate = await this.encryptPrivateKey(keyPair.privateKey, password);
Â  Â  Â  Â  Â  Â  this.downloadFile(JSON.stringify(encryptedPrivate, null, 2), 'Sadat-Falcon-private-key.json', 'application/json');

Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="valid">âœ… New key pair successfully generated and saved.</span>');
Â  Â  Â  Â  Â  Â  this.updateControlsState(true, true);
Â  Â  Â  Â  Â  Â  this.handleCreateNewNote();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Key generation failed:", e);
Â  Â  Â  Â  Â  Â  this.updateKeyStatus(`<span class="invalid">âŒ Key generation failed: ${e.message}</span>`);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async handleImportPublicKey(event) {
Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const data = JSON.parse(await file.text());
Â  Â  Â  Â  Â  Â  if (!data.keyData) throw new Error("Invalid public key file format.");
Â  Â  Â  Â  Â  Â  this.activeKeys.publicKey = this.base64ToUint8Array(data.keyData);
Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="valid">âœ… Public key successfully imported.</span>');
Â  Â  Â  Â  Â  Â  this.updateControlsState(!!this.activeKeys.privateKey, true);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  this.updateKeyStatus(`<span class="invalid">âŒ Error importing public key: ${error.message}</span>`);
Â  Â  Â  Â  }
Â  Â  Â  Â  event.target.value = '';
Â  Â  }

Â  Â  async handleImportPrivateKey(event) {
Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  const password = prompt("Enter the password for the private key file:");
Â  Â  Â  Â  if (!password) {
Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="invalid">âŒ Operation cancelled. Password is required.</span>');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const encryptedData = JSON.parse(await file.text());
Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="info">â³ Decrypting and importing private key...</span>');
Â  Â  Â  Â  Â  Â  const privateKey = await this.decryptPrivateKey(encryptedData, password);
Â  Â  Â  Â  Â  Â  this.activeKeys.privateKey = privateKey;
Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="valid">âœ… Private key successfully imported.</span>');
Â  Â  Â  Â  Â  Â  this.updateControlsState(true, !!this.activeKeys.publicKey);
Â  Â  Â  Â  Â  Â  this.handleCreateNewNote();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  this.updateKeyStatus(`<span class="invalid">âŒ Error decrypting or importing key. Check password or file: ${error.message}</span>`);
Â  Â  Â  Â  }
Â  Â  Â  Â  event.target.value = '';
Â  Â  }

Â  Â  downloadFile(data, filename, type) {
Â  Â  Â  Â  const blob = new Blob([data], { type: type });
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  a.download = filename;
Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  a.click();
Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  }
Â  Â Â 
Â  Â  // =================================================================
Â  Â  // Main Banknote Logic
Â  Â  // =================================================================
Â  Â  async createNoteData(amount, index = 0) {
Â  Â  Â  Â  if (!this.activeKeys.privateKey) {
Â  Â  Â  Â  Â  Â  alert("Error: No private key is active to sign the banknote.");
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const validatedAmount = parseInt(amount);
Â  Â  Â  Â  if (isNaN(validatedAmount) || validatedAmount <= 0) {
Â  Â  Â  Â  Â  Â  alert("Banknote amount must be a positive number.");
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  const noteData = {
Â  Â  Â  Â  Â  Â  amount: validatedAmount,
Â  Â  Â  Â  Â  Â  verificationKey: "SVK-" + Math.random().toString(16).substring(2, 10).toUpperCase(),
Â  Â  Â  Â  Â  Â  serial: "SDT-" + (now + index).toString().slice(-8),
Â  Â  Â  Â  Â  Â  timestamp: now
Â  Â  Â  Â  };
Â  Â  Â  Â  const stringToSign = this.getStandardizedDataForSigning(noteData);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const signatureBytes = await this.signData(stringToSign, this.activeKeys.privateKey);
Â  Â  Â  Â  noteData.signature = this.arrayBufferToBase64(signatureBytes);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const hashBytes = this.hashMessage(noteData.signature);
Â  Â  Â  Â  noteData.visualHash = this.uint8ArrayToHex(hashBytes);
Â  Â  Â  Â Â 
Â  Â  Â  Â  return noteData;
Â  Â  }

Â  Â  async handleCreateNewNote() {
Â  Â  Â  Â  const amount = document.getElementById("amount-input").value;
Â  Â  Â  Â  this.updateKeyStatus('<span class="info">â³ Generating a new banknote...</span>');
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const noteData = await this.createNoteData(amount);
Â  Â  Â  Â  Â  Â  if (noteData) {
Â  Â  Â  Â  Â  Â  Â  Â  await this.drawNoteOnCanvas(this.canvas, noteData, this.canvas.width, this.canvas.height);
Â  Â  Â  Â  Â  Â  Â  Â  this.currentNoteData = noteData;
Â  Â  Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="valid">âœ… New banknote design is ready.</span>');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  this.updateKeyStatus('<span class="invalid">âŒ Failed to generate a new banknote.</span>');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error creating new note:", e);
Â  Â  Â  Â  Â  Â  this.updateKeyStatus(`<span class="invalid">âŒ Internal error while generating banknote: ${e.message}</span>`);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async handleDownloadBatch() {
Â  Â  Â  Â  const quantity = parseInt(document.getElementById('quantity-input').value) || 1;
Â  Â  Â  Â  const amount = document.getElementById("amount-input").value;
Â  Â  Â  Â  const resultDiv = document.getElementById('key-status');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Check for File System Access API support
Â  Â  Â  Â  if (window.showDirectoryPicker) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="info">â³ Processing ${quantity} banknotes... Please wait.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < quantity; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteData = await this.createNoteData(amount, i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!noteData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="invalid">âŒ Batch download stopped.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const offscreenCanvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  offscreenCanvas.width = this.canvas.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  offscreenCanvas.height = this.canvas.height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await this.drawNoteOnCanvas(offscreenCanvas, noteData, offscreenCanvas.width, offscreenCanvas.height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const blob = await new Promise(resolve => offscreenCanvas.toBlob(resolve, 'image/png'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fileHandle = await dirHandle.getFileHandle(`SADAT-NOTE-${noteData.serial}.png`, { create: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const writable = await fileHandle.createWritable();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await writable.write(blob);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await writable.close();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="info">âœ… Banknote ${i + 1} of ${quantity} saved.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="valid">âœ… Successfully saved ${quantity} banknotes to your selected folder.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  this.handleCreateNewNote();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  if (error.name === 'AbortError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="info">Operation cancelled by user.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Batch download failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="invalid">âŒ Error saving files: ${error.message}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Fallback to ZIP download
Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="info">âš ï¸ Your browser does not support folder selection. Downloading as a ZIP file...</span>`;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const zip = new JSZip();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < quantity; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteData = await this.createNoteData(amount, i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!noteData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="invalid">âŒ Batch download stopped.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const offscreenCanvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  offscreenCanvas.width = this.canvas.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  offscreenCanvas.height = this.canvas.height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await this.drawNoteOnCanvas(offscreenCanvas, noteData, offscreenCanvas.width, offscreenCanvas.height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const blob = await new Promise(resolve => offscreenCanvas.toBlob(resolve, 'image/png'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  zip.file(`SADAT-NOTE-${noteData.serial}.png`, blob);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const zipBlob = await zip.generateAsync({type:"blob"});
Â  Â  Â  Â  Â  Â  Â  Â  this.downloadFile(zipBlob, `SADAT-NOTES-BATCH-${Date.now()}.zip`, 'application/zip');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `<span class="valid">âœ… Successfully saved ${quantity} banknotes as a ZIP file.</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  this.handleCreateNewNote();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Batch download failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â resultDiv.innerHTML = `<span class="invalid">âŒ Error: ${error.message}</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // =================================================================
Â  Â  // Banknote Validation
Â  Â  // =================================================================
Â  Â  async handleVerifyNoteManually() {
Â  Â  Â  Â  if (!this.activeKeys.publicKey) {
Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="invalid">âŒ No public key loaded for signature verification.</span>');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const amount = document.getElementById('verify-amount').value;
Â  Â  Â  Â  const serial = document.getElementById('verify-serial').value;
Â  Â  Â  Â  const verificationKey = document.getElementById('verify-verification-key').value;
Â  Â  Â  Â  const signatureBase64 = document.getElementById('verify-signature').value;

Â  Â  Â  Â  if (!amount || !serial || !verificationKey || !signatureBase64) {
Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="invalid">âŒ Please fill in all fields.</span>');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const noteData = {
Â  Â  Â  Â  Â  Â  amount: amount,
Â  Â  Â  Â  Â  Â  serial: serial,
Â  Â  Â  Â  Â  Â  verificationKey: verificationKey,
Â  Â  Â  Â  Â  Â  timestamp: parseInt(serial.slice(-8))
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  await this._processVerification(noteData, signatureBase64);
Â  Â  }
Â  Â Â 
Â  Â  async handleVerifyFromImage(event) {
Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  if (!this.isOpenCvReady) {
Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="info">â³ OpenCV library is still loading. Please wait a moment.</span>');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  this.updateValidationResult('<span class="info">â³ Processing image and extracting data...</span>');
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const image = new Image();
Â  Â  Â  Â  Â  Â  image.src = URL.createObjectURL(file);

Â  Â  Â  Â  Â  Â  image.onload = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  // Create a temporary canvas for image data
Â  Â  Â  Â  Â  Â  Â  Â  const tempCanvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  tempCanvas.width = image.width;
Â  Â  Â  Â  Â  Â  Â  Â  tempCanvas.height = image.height;
Â  Â  Â  Â  Â  Â  Â  Â  const tempCtx = tempCanvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  tempCtx.drawImage(image, 0, 0, image.width, image.height);

Â  Â  Â  Â  Â  Â  Â  Â  // Load image into OpenCV Mat object
Â  Â  Â  Â  Â  Â  Â  Â  let src = cv.imread(tempCanvas);
Â  Â  Â  Â  Â  Â  Â  Â  let dst = new cv.Mat();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Convert to grayscale for better processing
Â  Â  Â  Â  Â  Â  Â  Â  cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY, 0);

Â  Â  Â  Â  Â  Â  Â  Â  // Apply Adaptive Thresholding - a powerful technique for low-quality images
Â  Â  Â  Â  Â  Â  Â  Â  // blockSize is the size of the neighborhood area. It must be an odd number.
Â  Â  Â  Â  Â  Â  Â  Â  // C is a constant subtracted from the mean.
Â  Â  Â  Â  Â  Â  Â  Â  cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 5);

Â  Â  Â  Â  Â  Â  Â  Â  // Display the processed image (optional, for debugging)
Â  Â  Â  Â  Â  Â  Â  Â  // cv.imshow('noteCanvas', dst);

Â  Â  Â  Â  Â  Â  Â  Â  // Pass the enhanced image data to jsQR
Â  Â  Â  Â  Â  Â  Â  Â  const imageData = new ImageData(new Uint8ClampedArray(dst.data), dst.cols, dst.rows);
Â  Â  Â  Â  Â  Â  Â  Â  const qrCode = jsQR(imageData.data, imageData.width, imageData.height);

Â  Â  Â  Â  Â  Â  Â  Â  // Clean up memory
Â  Â  Â  Â  Â  Â  Â  Â  src.delete();
Â  Â  Â  Â  Â  Â  Â  Â  dst.delete();

Â  Â  Â  Â  Â  Â  Â  Â  if (qrCode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteData = JSON.parse(qrCode.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('verify-amount').value = noteData.amount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('verify-serial').value = noteData.serial;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('verify-verification-key').value = noteData.verificationKey;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('verify-signature').value = noteData.signature;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="info">âœ… Data extracted from image. Verifying...</span>');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await this._processVerification(noteData, noteData.signature);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.updateValidationResult(`<span class="invalid">âŒ Invalid QR code data: ${error.message}</span>`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="invalid">âŒ No QR code found in the image. Please ensure the QR code is clear and not obscured.</span>');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(image.src);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  this.updateValidationResult(`<span class="invalid">âŒ Error processing image: ${error.message}</span>`);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  event.target.value = '';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async _processVerification(noteData, signatureBase64) {
Â  Â  Â  Â  if (!this.activeKeys.publicKey) {
Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="invalid">âŒ No public key loaded for signature verification.</span>');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const stringToVerify = this.getStandardizedDataForSigning(noteData);
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const signatureBytes = this.base64ToUint8Array(signatureBase64);
Â  Â  Â  Â  Â  Â  const isValid = await this.verifySignature(stringToVerify, signatureBytes, this.activeKeys.publicKey);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isValid) {
Â  Â  Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="valid">âœ… Signature is valid. This banknote is authentic.</span>');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  this.updateValidationResult('<span class="invalid">âŒ Signature is invalid. This banknote is fake or has been tampered with.</span>');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  this.updateValidationResult(`<span class="invalid">âŒ Verification error: ${e.message}</span>`);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // =================================================================
Â  Â  // Graphical Helper Functions
Â  Â  // =================================================================
Â  Â  H = (text, index, min, max) => min + (parseInt(text.substring(index, index + 2), 16) % (max - min + 1));
Â  Â Â 
Â  Â  async drawNoteOnCanvas(targetCanvas, noteData, width, height) {
Â  Â  Â  Â  return new Promise(async (resolve, reject) => {
Â  Â  Â  Â  Â  Â  if (!noteData || Object.keys(noteData).length === 0) return reject("Banknote data not provided.");
Â  Â Â 
Â  Â  Â  Â  Â  Â  const ctx = targetCanvas.getContext("2d");
Â  Â  Â  Â  Â  Â  const { amount, verificationKey, serial, visualHash } = noteData;
Â  Â  Â  Â  Â  Â  const w = width, h = height, scale = w / 1350;Â  Â Â 
Â  Â Â 
Â  Â  Â  Â  Â  Â  const bgGradient = ctx.createLinearGradient(0, 0, 0, h);
Â  Â  Â  Â  Â  Â  const baseHue = this.H(visualHash, 0, 0, 360);
Â  Â  Â  Â  Â  Â  bgGradient.addColorStop(0, `hsl(${baseHue}, 50%, 6%)`);
Â  Â  Â  Â  Â  Â  bgGradient.addColorStop(1, `hsl(${baseHue}, 40%, 4%)`);
Â  Â  Â  Â  Â  Â  ctx.fillStyle = bgGradient;
Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, w, h);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  this.drawWatermark(ctx, visualHash, w, h);
Â  Â  Â  Â  Â  Â  this.drawKochGuilloche(ctx, visualHash, w, h);
Â  Â  Â  Â  Â  Â  this.drawNoisePattern(ctx, visualHash, w, h);
Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.shadowColor="rgba(0,0,0,0.7)"; ctx.shadowBlur=8*scale; ctx.shadowOffsetX=2*scale; ctx.shadowOffsetY=2*scale;
Â  Â  Â  Â  Â  Â  ctx.fillStyle="#EAEAEA"; ctx.font=`bold ${80*scale}px 'Roboto Mono'`; ctx.textAlign='left';
Â  Â  Â  Â  Â  Â  ctx.fillText(serial.substring(4),150*scale,160*scale); ctx.fillText(verificationKey.substring(4),150*scale,280*scale);
Â  Â  Â  Â  Â  Â  ctx.font=`bold ${150*scale}px 'Roboto Mono'`; ctx.textAlign="right";
Â  Â  Â  Â  Â  Â  ctx.shadowBlur=12*scale; ctx.shadowOffsetX=4*scale; ctx.shadowOffsetY=4*scale;
Â  Â  Â  Â  Â  Â  ctx.fillText(amount.toString(),w-(120*scale),190*scale); ctx.shadowColor="transparent";
Â  Â Â 
Â  Â  Â  Â  Â  Â  const qrCanvas = document.createElement("canvas");
Â  Â  Â  Â  Â  Â  const qrSize = 380 * scale;
Â  Â  Â  Â  Â  Â  QRCode.toCanvas(qrCanvas, JSON.stringify(noteData), { width: qrSize, errorCorrectionLevel: 'H', color: { dark: '#000000', light: '#FFFFFF' } }, (err) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (err) { reject(err); return; }
Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(qrCanvas, w - (150 * scale) - qrSize, h - (520 * scale), qrSize, qrSize);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font=`${30*scale}px 'Poppins'`; ctx.fillStyle="rgba(255,255,255,0.4)"; ctx.textAlign="center";
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText("Digitally Signed by Sadat Bank Authority (Falcon-512)", w/2, h-60*scale);
Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  drawKochGuilloche(g_ctx, hash, w, h) { g_ctx.save();g_ctx.translate(w/2,h/2);const s=w/1350,it=this.H(hash,2,2,4),sz=w*(this.H(hash,4,10,20)/100),aO=(this.H(hash,6,0,360)/360)*Math.PI*2,nL=this.H(hash,8,3,6),hO=this.H(hash,10,0,360);function d(x1,y1,x2,y2,l){if(l===0){g_ctx.lineTo(x2,y2);return}const dx=x2-x1,dy=y2-y1,di=Math.sqrt(dx*dx+dy*dy),ux=dx/di,uy=dy/di,p1x=x1+ux*di/3,p1y=y1+uy*di/3,p2x=x1+ux*di*2/3,p2y=y1+uy*di*2/3,p3x=p1x+ux*di/6-uy*di*Math.sqrt(3)/6,p3y=p1y+uy*di/6+ux*di*Math.sqrt(3)/6;d(x1,y1,p1x,p1y,l-1);d(p1x,p1y,p3x,p3y,l-1);d(p3x,p3y,p2x,p2y,l-1);d(p2x,p2y,x2,y2,l-1)}g_ctx.lineWidth=1*s;g_ctx.lineJoin='bevel';g_ctx.lineCap='round';for(let i=0;i<nL;i++){const hu=(hO+i*(360/nL))%360;g_ctx.strokeStyle=`hsla(${hu},70%,60%,0.15)`;const lA=(i/nL)*Math.PI*2+aO,x1=Math.cos(lA)*sz,y1=Math.sin(lA)*sz,x2=Math.cos(lA+Math.PI)*sz,y2=Math.sin(lA+Math.PI)*sz;g_ctx.beginPath();g_ctx.moveTo(x1,y1);d(x1,y1,x2,y2,it);g_ctx.stroke()}g_ctx.restore() }
Â  Â  drawWatermark(g_ctx, hash, w, h) { g_ctx.save();g_ctx.translate(w/2,h/2);const s=w/1350,nS=this.H(hash,16,3,6),sR=w*(this.H(hash,18,10,25)/100)*s,hu=this.H(hash,20,0,360);g_ctx.strokeStyle=`hsla(${hu},50%,80%,0.05)`;g_ctx.lineWidth=4*s;for(let i=0;i<nS;i++){g_ctx.beginPath();const sA=(i/nS)*Math.PI*2+this.H(hash,22,0,100)/100,eA=sA+this.H(hash,24,6,12)*Math.PI;for(let t=sA;t<eA;t+=0.05){const r=sR*(t-sA)/(eA-sA),x=r*Math.cos(t),y=r*Math.sin(t);if(t===sA)g_ctx.moveTo(x,y);else g_ctx.lineTo(x,y)}g_ctx.stroke()}g_ctx.restore() }
Â  Â  drawNoisePattern(g_ctx, hash, w, h) { g_ctx.save();
Â  Â  for (let i=0; i<20000; i++) { const x=Math.random()*w, y=Math.random()*h, o=Math.random()*0.15, hue=this.H(hash,(i%30)+4,0,360); g_ctx.fillStyle=`hsla(${hue},50%,80%,${o})`;
Â  Â  g_ctx.fillRect(x,y,1,1) } g_ctx.restore() }

Â  Â  // =================================================================
Â  Â  // Private Key Encryption/Decryption with Web Crypto API
Â  Â  // =================================================================
Â  Â  AES_ALGO = "AES-GCM";
Â  Â  PBKDF2_ITERATIONS = 100000;
Â  Â  PBKDF2_HASH_ALGO = "SHA-256";
Â  Â  AES_KEY_LENGTH = 256;
Â  Â Â 
Â  Â  async encryptPrivateKey(privateKeyBytes, password) {
Â  Â  Â  Â  const passwordBuffer = new TextEncoder().encode(password);
Â  Â  Â  Â  const salt = window.crypto.getRandomValues(new Uint8Array(16));
Â  Â  Â  Â  const iv = window.crypto.getRandomValues(new Uint8Array(12));
Â  Â  Â  Â  const keyMaterial = await window.crypto.subtle.importKey(
Â  Â  Â  Â  Â  Â  "raw", passwordBuffer, { name: "PBKDF2" }, false, ["deriveKey"]
Â  Â  Â  Â  );
Â  Â  Â  Â  const derivedKey = await window.crypto.subtle.deriveKey(
Â  Â  Â  Â  Â  Â  { name: "PBKDF2", salt: salt, iterations: this.PBKDF2_ITERATIONS, hash: this.PBKDF2_HASH_ALGO },
Â  Â  Â  Â  Â  Â  keyMaterial,
Â  Â  Â  Â  Â  Â  { name: this.AES_ALGO, length: this.AES_KEY_LENGTH },
Â  Â  Â  Â  Â  Â  true,
Â  Â  Â  Â  Â  Â  ["encrypt", "decrypt"]
Â  Â  Â  Â  );
Â  Â  Â  Â  const keyObject = { keyData: this.arrayBufferToBase64(privateKeyBytes) };
Â  Â  Â  Â  const encodedKey = new TextEncoder().encode(JSON.stringify(keyObject));
Â  Â  Â  Â  const encryptedKey = await window.crypto.subtle.encrypt(
Â  Â  Â  Â  Â  Â  { name: this.AES_ALGO, iv: iv }, derivedKey, encodedKey
Â  Â  Â  Â  );
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  cipherText: this.arrayBufferToBase64(encryptedKey),
Â  Â  Â  Â  Â  Â  salt: this.arrayBufferToBase64(salt),
Â  Â  Â  Â  Â  Â  iv: this.arrayBufferToBase64(iv),
Â  Â  Â  Â  Â  Â  algo: this.AES_ALGO,
Â  Â  Â  Â  Â  Â  hash: this.PBKDF2_HASH_ALGO,
Â  Â  Â  Â  Â  Â  iterations: this.PBKDF2_ITERATIONS
Â  Â  Â  Â  };
Â  Â  }

Â  Â  async decryptPrivateKey(encryptedData, password) {
Â  Â  Â  Â  const passwordBuffer = new TextEncoder().encode(password);
Â  Â  Â  Â  const salt = this.base64ToUint8Array(encryptedData.salt);
Â  Â  Â  Â  const iv = this.base64ToUint8Array(encryptedData.iv);
Â  Â  Â  Â  const cipherText = this.base64ToUint8Array(encryptedData.cipherText);
Â  Â  Â  Â  const keyMaterial = await window.crypto.subtle.importKey(
Â  Â  Â  Â  Â  Â  "raw", passwordBuffer, { name: "PBKDF2" }, false, ["deriveKey"]
Â  Â  Â  Â  );
Â  Â  Â  Â  const derivedKey = await window.crypto.subtle.deriveKey(
Â  Â  Â  Â  Â  Â  { name: "PBKDF2", salt: salt, iterations: encryptedData.iterations, hash: encryptedData.hash },
Â  Â  Â  Â  Â  Â  keyMaterial,
Â  Â  Â  Â  Â  Â  { name: this.AES_ALGO, length: this.AES_KEY_LENGTH },
Â  Â  Â  Â  Â  Â  true,
Â  Â  Â  Â  Â  Â  ["encrypt", "decrypt"]
Â  Â  Â  Â  );
Â  Â  Â  Â  const decryptedKeyBuffer = await window.crypto.subtle.decrypt(
Â  Â  Â  Â  Â  Â  { name: this.AES_ALGO, iv: iv }, derivedKey, cipherText
Â  Â  Â  Â  );
Â  Â  Â  Â  const keyObject = JSON.parse(new TextDecoder().decode(decryptedKeyBuffer));
Â  Â  Â  Â  return this.base64ToUint8Array(keyObject.keyData);
Â  Â  }
}

// Global flag to track OpenCV readiness
window.onOpenCvReady = () => {
Â  Â  app.onOpenCvReady();
};

// Instantiate the app and start it
const app = new SadatBanknoteApp();
app.init();
</script>
</body>
</html>
