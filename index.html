<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø§Ú˜ÙˆÙ„Ø§Ø±</title>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            padding: 20px; 
            background-color: #f4f7f9;
            color: #333;
            max-width: 850px; 
            margin: auto; 
            line-height: 1.6;
        }
        h2, h3 {
            color: #1a237e;
            border-bottom: 2px solid #c5cae9;
            padding-bottom: 10px;
        }
        textarea, button { 
            width: 100%; 
            padding: 12px; 
            margin-top: 10px; 
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button { 
            background-color: #3f51b5; 
            color: white; 
            border: none; 
            cursor: pointer; 
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { 
            background-color: #303f9f; 
        }
        button:disabled {
            background-color: #9fa8da;
            cursor: not-allowed;
        }
        .output-group {
            background: #fff; 
            padding: 15px; 
            margin-top: 15px; 
            border-radius: 6px; 
            border: 1px solid #e0e0e0;
            word-break: break-all; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .status { font-weight: bold; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
        .status.success { color: #1b5e20; background-color: #c8e6c9; }
        .status.error { color: #b71c1c; background-color: #ffcdd2; }
        .status.loading { color: #0d47a1; background-color: #bbdefb; }
    </style>
</head>
<body>
    <h2>Ø§Ù…Ø¶Ø§ Ø¨Ø§ Ed25519 + Falcon-512 + SHAKE256 (Ù…Ø¹Ù…Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„Ø§Ø±)</h2>

    <div id="initStatus" class="status loading">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§...</div>
    
    <h3>Û±. Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
    <div class="output-group">
        <strong>Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Ed25519 (Base64):</strong>
        <div id="ed25519Pk">...</div>
        <hr>
        <strong>Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Falcon-512 (Base64):</strong>
        <div id="falconPk">...</div>
    </div>

    <h3>Û². Ù¾ÛŒØ§Ù… Ùˆ Ø§Ù…Ø¶Ø§</h3>
    <textarea id="message" rows="5" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
    <button id="signButton" disabled>ğŸ–‹ ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø¶Ø§</button>

    <div class="output-group">
        <strong>Ø§Ù…Ø¶Ø§ÛŒ Ed25519 (Base64):</strong>
        <div id="ed25519Sig"></div>
        <hr>
        <strong>Ø§Ù…Ø¶Ø§ÛŒ Falcon-512 (Base64):</strong>
        <div id="falconSig"></div>
    </div>
    
    <h3>Û³. Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù…Ø¶Ø§</h3>
    <button id="verifyButton" disabled>âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±</button>
    <div id="verifyResult" class="output-group" style="display: none;"></div>

<script type="module">
    // Ù…Ø±Ø­Ù„Ù‡ Û±: ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† (import) ØªÙ…Ø§Ù… Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ú˜ÙˆÙ„
    // ÙØ§ÛŒÙ„ falcon.js Ø´Ù…Ø§ Ø§Ø² Ù…Ø³ÛŒØ± Ù…Ø­Ù„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    import pqcSignFalcon512 from './falcon.js';
    
    // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø§Ø² ÛŒÚ© CDN Ù…Ø¯Ø±Ù† Ú©Ù‡ Ø§Ø² Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
    import nacl from 'https://cdn.skypack.dev/tweetnacl';
    import { shake256 } from 'https://cdn.skypack.dev/js-sha3';

    // --- DOM Elements ---
    const dom = {
        initStatus: document.getElementById('initStatus'),
        signButton: document.getElementById('signButton'),
        verifyButton: document.getElementById('verifyButton'),
        ed25519Pk: document.getElementById('ed25519Pk'),
        falconPk: document.getElementById('falconPk'),
        ed25519Sig: document.getElementById('ed25519Sig'),
        falconSig: document.getElementById('falconSig'),
        verifyResult: document.getElementById('verifyResult'),
        message: document.getElementById('message'),
    };

    // --- State Management ---
    let state = {
        falconApi: null,
        keys: { ed25519: null, falcon: null },
        signatures: { ed25519: null, falcon: null },
        messageHash: null,
    };
    
    const bytesToBase64 = (bytes) => btoa(String.fromCharCode(...bytes));
    
    // --- Initialization ---
    async function initialize() {
        try {
            // Ed25519 and SHAKE256 are ready because they were imported.
            state.keys.ed25519 = nacl.sign.keyPair();

            // Initialize Falcon by calling the imported function
            state.falconApi = await pqcSignFalcon512();
            state.keys.falcon = await state.falconApi.keypair();
            
            // Success
            dom.initStatus.textContent = 'âœ… ØªÙ…Ø§Ù… Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.';
            dom.initStatus.className = 'status success';
            dom.ed25519Pk.textContent = bytesToBase64(state.keys.ed25519.publicKey);
            dom.falconPk.textContent = bytesToBase64(state.keys.falcon.publicKey);
            dom.signButton.disabled = false;

        } catch (e) {
            console.error("Initialization Error:", e);
            dom.initStatus.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§: ${e.message}`;
            dom.initStatus.className = 'status error';
        }
    }
    
    const hexToBytes = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
    function hashMessage(msg) {
        // Now we use the imported `shake256` function directly, not `sha3.shake256`
        return hexToBytes(shake256(msg, 1024));
    }
    
    async function handleSign() {
        dom.signButton.disabled = true;
        state.messageHash = hashMessage(dom.message.value);
        
        // Ed25519 Signing
        const edSig = nacl.sign.detached(state.messageHash, state.keys.ed25519.secretKey);
        state.signatures.ed25519 = edSig;
        dom.ed25519Sig.textContent = bytesToBase64(edSig);
        
        // Falcon Signing
        const { signature: falSig } = await state.falconApi.sign(state.messageHash, state.keys.falcon.privateKey);
        state.signatures.falcon = falSig;
        dom.falconSig.textContent = bytesToBase64(falSig);

        dom.signButton.disabled = false;
        dom.verifyButton.disabled = false;
        dom.verifyResult.style.display = 'none';
    }
    
    async function handleVerify() {
        let resultsHTML = '';
        
        // Ed25519 Verification
        const edIsValid = nacl.sign.detached.verify(state.messageHash, state.signatures.ed25519, state.keys.ed25519.publicKey);
        resultsHTML += `<strong>Ed25519:</strong> ${edIsValid ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}<br>`;
        
        // Falcon Verification
        const falIsValid = await state.falconApi.verify(state.signatures.falcon, state.messageHash, state.keys.falcon.publicKey);
        resultsHTML += `<strong>Falcon-512:</strong> ${falIsValid ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}`;

        dom.verifyResult.innerHTML = resultsHTML;
        dom.verifyResult.style.display = 'block';
    }

    // --- Event Listeners ---
    dom.signButton.addEventListener('click', handleSign);
    dom.verifyButton.addEventListener('click', handleVerify);

    // --- Start Application ---
    initialize();
</script>
</body>
</html>
