<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Wallet (S-Tier)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* --- S-TIER DESIGN SYSTEM: THEMES, ANIMATIONS, RESPONSIVENESS --- */
        
        /* 1. THEME DEFINITIONS */
        :root { /* Default Theme: Aurora */
            --bg-color: #0a0f1f;
            --surface-color: rgba(16, 23, 43, 0.75);
            --primary-color: #00f5d4;
            --accent-color: #9b5de5;
            --danger-color: #ef476f;
            --success-color: #25a244;
            --text-light: #e0e0e0;
            --text-dark: #ffffff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(0, 0, 0, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --backdrop-blur: 20px;
            --bg-image: radial-gradient(at 20% 25%, hsla(212,80%,50%,0.3) 0px, transparent 50%),
                        radial-gradient(at 80% 75%, hsla(289,80%,50%,0.3) 0px, transparent 50%);
        }
        body[data-theme='neon-noir'] {
            --bg-color: #000000;
            --surface-color: rgba(20, 20, 20, 0.85);
            --primary-color: #39ff14; /* Electric Lime */
            --accent-color: #39ff14;
            --danger-color: #ff3131;
            --success-color: #00ff7f;
            --text-light: #f0f0f0;
            --text-dark: #ffffff;
            --border-color: rgba(57, 255, 20, 0.3);
            --input-bg: rgba(255, 255, 255, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --backdrop-blur: 10px;
            --bg-image: none;
        }
        body[data-theme='solana-breeze'] {
            --bg-color: #f8f9fa;
            --surface-color: rgba(255, 255, 255, 0.8);
            --primary-color: #8A2BE2; /* BlueViolet */
            --accent-color: #00BFFF; /* DeepSkyBlue */
            --danger-color: #d9534f;
            --success-color: #1e8e3e;
            --text-light: #343a40;
            --text-dark: #212529;
            --border-color: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --backdrop-blur: 25px;
            --bg-image: radial-gradient(at 10% 20%, hsla(271, 91%, 63%, 0.1) 0px, transparent 50%),
                        radial-gradient(at 80% 80%, hsla(198, 91%, 63%, 0.1) 0px, transparent 50%);
        }

        /* 2. BASE & MOBILE-FIRST STYLES */
        * { box-sizing: border-box; }

        html { font-size: 16px; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            margin: 0;
            color: var(--text-light);
            transition: background-color 0.5s ease;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px 15px;
        }

        .view-container {
            width: 100%;
            max-width: 500px;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .view {
            width: 100%;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98);
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
        }
        .view.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
            position: relative;
        }

        .card {
            background-color: var(--surface-color);
            backdrop-filter: blur(var(--backdrop-blur));
            -webkit-backdrop-filter: blur(var(--backdrop-blur));
            padding: 30px 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
        }

        h1, h2 {
            color: var(--text-dark);
            font-weight: 700;
            margin: 0 0 10px 0;
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.6rem; }
        p {
            line-height: 1.6;
            margin: 0 0 20px 0;
            font-size: 0.95rem;
        }

        .input-with-icon {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }
        .input-with-icon svg {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            opacity: 0.4;
            width: 18px;
            height: 18px;
            color: var(--text-light);
            pointer-events: none;
        }
        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background-color: var(--input-bg);
            color: var(--text-light);
            text-align: center;
            transition: all 0.3s ease;
        }
        .input-with-icon input {
            padding-left: 45px;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px color-mix(in srgb, var(--primary-color) 30%, transparent);
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            color: var(--bg-color);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        body[data-theme='solana-breeze'] button { color: white; }

        button:hover {
            opacity: 0.9;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }
        
        button:disabled {
            background: color-mix(in srgb, var(--surface-color) 50%, #555);
            color: color-mix(in srgb, var(--text-light) 50%, transparent);
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        .back-button {
            background: color-mix(in srgb, var(--surface-color), transparent 20%);
            color: var(--text-light);
            margin-top: 10px;
        }
        .logout-button {
            background: var(--danger-color);
            color: var(--text-dark);
            margin-top: 10px;
        }

        #balance-display {
            font-size: 2.8rem;
            font-weight: 700;
            margin: 5px 0 20px 0;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .transaction-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: color-mix(in srgb, var(--input-bg) 50%, transparent);
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }
        .transaction-item:hover {
            background: var(--input-bg);
            transform: scale(1.02);
        }
        .tx-icon { flex-shrink: 0; }
        .transaction-details {
            flex-grow: 1;
            text-align: left;
        }
        .transaction-amount {
            font-weight: 700;
            text-align: right;
        }
        .transaction-type.sent, .tx-icon .sent { color: var(--danger-color); }
        .transaction-type.received, .tx-icon .received { color: var(--success-color); }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
        }
        .modal-content {
            width: 100%;
            max-width: 450px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 3. DESKTOP STYLES & OVERRIDES */
        @media (min-width: 768px) {
            .view-container { align-items: center; }
            .card { padding: 35px; }
            h1 { font-size: 2.5rem; }
            h2 { font-size: 1.8rem; }
            p { font-size: 1rem; }
            #balance-display { font-size: 3.5rem; }
            .transaction-list { max-height: 220px; }
        }
        
        /* 4. Component-Specific Styles */
        .theme-switcher-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .theme-button { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid var(--border-color); transition: all 0.2s ease; padding: 0; }
        .theme-button:hover, .theme-button.active { transform: scale(1.15); border-color: var(--text-dark); }
        #theme-aurora { background: linear-gradient(45deg, #0a0f1f, #00f5d4, #9b5de5); }
        #theme-neon-noir { background: linear-gradient(45deg, #000000, #39ff14); }
        #theme-solana-breeze { background: linear-gradient(45deg, #f8f9fa, #8A2BE2, #00BFFF); }
    </style>
</head>
<body>

<div class="view-container">
    <div id="onboarding-view" class="view active"><div class="card"><h1>Aura Wallet</h1><p>A new generation of asset security and control</p><button id="go-to-create-wallet">Create a New Wallet</button><button id="go-to-restore-wallet" class="back-button">Restore Wallet</button></div></div>
    <div id="create-wallet-view" class="view"><div class="card"><h2>Create Password</h2><p>Choose a strong password to encrypt your wallet.</p><div class="input-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg><input type="password" id="create-password-input" placeholder="Password"></div><div class="input-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg><input type="password" id="confirm-password-input" placeholder="Confirm Password"></div><div class="loader hidden" id="create-loader"></div><button id="create-wallet-button">Create Wallet</button><div id="create-status" class="status-box"></div><button class="back-button" id="back-from-create">Back</button></div></div>
    <div id="seed-phrase-view" class="view"><div class="card"><h2>Recovery Phrase</h2><p class="error">Write down these 12 words. This is the only way to recover your wallet.</p><div id="seed-phrase-display" style="padding: 20px; border: 1px dashed var(--danger-color); border-radius: 12px; margin: 20px 0; background-color: color-mix(in srgb, var(--danger-color) 10%, transparent); color: var(--text-light); font-size: 1.1rem; letter-spacing: 1.5px; font-family: monospace; line-height: 1.8;"></div><button id="seed-phrase-confirm-button">I Understand, Open My Wallet</button></div></div>
    <div id="restore-wallet-view" class="view"><div class="card"><h2>Restore Wallet</h2><p>Enter your 12-word recovery phrase and a new password.</p><textarea id="restore-seed-input" placeholder="Enter words separated by spaces..." style="margin-bottom: 15px; height: 80px;"></textarea><div class="input-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg><input type="password" id="restore-password-input" placeholder="New Password"></div><div class="loader hidden" id="restore-loader"></div><button id="restore-wallet-button">Restore</button><div id="restore-status" class="status-box"></div><button class="back-button" id="back-from-restore">Back</button></div></div>
    <div id="login-view" class="view"><div class="card"><h1>Unlock Wallet</h1><p>Enter your password to decrypt your wallet.</p><div class="input-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg><input type="password" id="login-password-input" placeholder="Password"></div><div class="loader hidden" id="login-loader"></div><button id="login-button">Unlock</button><div id="login-status" class="status-box"></div><p style="margin-top:20px; font-size: 0.9rem;">Want to use a different wallet? <button id="reset-app-button" style="background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; padding: 5px; width: auto; font-size: 0.9rem; display: inline;">Erase and start over</button></p></div></div>
    
    <div id="wallet-view" class="view"><div class="card">
        <h2>Dashboard</h2>
        <div style="background: var(--input-bg); padding: 8px 8px 8px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
            <span id="address-display" style="font-family: monospace; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
            <button id="copy-address-button" style="padding: 8px 12px; font-size: 12px; width: auto; background: color-mix(in srgb, var(--border-color), transparent 20%); min-width: 80px; flex-shrink: 0;">Copy</button>
        </div>
        <p style="margin-bottom:0; font-size: 14px; opacity: 0.7;">Total Balance</p>
        <h1 id="balance-display">$0.00</h1>
        <div id="sync-status" class="status-box" style="font-size: 14px; min-height: 20px;"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
            <button id="show-send-view-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>Send</button>
            <button id="show-receive-view-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M5 15l7 7 7-7"/></svg>Receive</button>
        </div>
        <button id="show-charge-view-button">Charge with Banknote</button>

        <div class="transaction-history" style="margin-top: 30px; text-align: left;">
            <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-dark); font-weight: 600;">Recent Transactions</h3>
            <ul id="transaction-list-ul" class="transaction-list"></ul>
        </div>
        <button id="logout-button" class="logout-button">Logout</button>
        <div class="theme-switcher-container">
            <button class="theme-button" id="theme-aurora" data-theme="aurora" aria-label="Aurora Theme"></button>
            <button class="theme-button" id="theme-neon-noir" data-theme="neon-noir" aria-label="Neon Noir Theme"></button>
            <button class="theme-button" id="theme-solana-breeze" data-theme="solana-breeze" aria-label="Solana Breeze Theme"></button>
        </div>
    </div></div>
    
    <div id="send-view" class="view"><div class="card"><h2>Send Funds</h2>
        <div class="input-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"></path></svg><input type="text" id="send-address-input" placeholder="Recipient's Aura Address"></div>
        <div class="input-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg><input type="number" id="send-amount-input" placeholder="Amount to send"></div>
        <div class="input-with-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><input type="text" id="send-comment-input" placeholder="Short comment (optional)" maxlength="50"></div>
        <button id="send-manual-button">Continue</button>
        <p style="text-align:center; margin: 20px 0; font-weight: bold; opacity: 0.7;">- OR -</p>
        <div id="video-container" style="position: relative; width: 100%; max-width: 300px; margin: 15px auto; border-radius: 8px; overflow: hidden; border: 2px solid var(--border-color); background: #000;"><video id="qr-video" playsinline style="width: 100%; height: auto; display: block;"></video></div>
        <canvas id="qr-canvas" style="display: none;"></canvas><div id="send-status" class="status-box"></div>
        <button class="back-button" id="back-from-send">Back</button>
    </div></div>
    
    <div id="transaction-detail-modal" class="modal-overlay" style="display:none;" role="dialog" aria-modal="true">
        <div class="modal-content card"><h2>Transaction Details</h2>
            <div id="modal-details-content" style="text-align:left; font-size: 0.9rem; line-height: 1.8;">
                 </div>
            <button id="download-tx-button">Download as JPG</button>
            <button id="close-modal-button" class="back-button">Close</button>
        </div>
    </div>
    </div>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="pako.min.js"></script>
    <script src="qrcode.js"></script>
    <script src="jsQR.js"></script>
    <script src="crypto-js.min.js"></script>
    <script src="html2canvas.min.js"></script>
    
    <script type="module">
        if (typeof globalThis.Buffer === 'undefined') {
            globalThis.Buffer = { from: (input, encoding) => { if (encoding === 'base64') { const binary = atob(input); const len = binary.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i); return bytes; } return new TextEncoder().encode(input); } };
        }

        import { ethers } from "./ethers.min.js";
        const SUPABASE_URL = 'https://hdvqbcjtublfuykigsui.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkdnFiY2p0dWJsZnV5a2lnc3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTk4OTAsImV4cCI6MjA3MTUzNTg5MH0.Gog9zohe1bz6gihtssCBPUYkfNMbAjuQKR4Qvb3HNOg';
        const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/api`;
        
        // --- S-TIER UX & THEME MANAGEMENT ---
        function applyTheme(themeName) {
            document.body.dataset.theme = themeName;
            localStorage.setItem('aura_theme', themeName);
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === themeName);
            });
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('aura_theme') || 'aurora';
            applyTheme(savedTheme);
        }
        function animateCountUp(element, finalValue, duration = 1000) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentVal = progress * finalValue;
                element.textContent = `$${currentVal.toFixed(2)}`;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    element.textContent = `$${finalValue.toFixed(2)}`;
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- All other JS logic is included here for a complete, runnable file ---
        const SecurityUtils = {getDOMPurifyConfig:()=>({ALLOWED_TAGS:[],ALLOWED_ATTR:[],KEEP_CONTENT:!0,RETURN_DOM:!1,RETURN_DOM_FRAGMENT:!1,SANITIZE_DOM:!0,FORCE_BODY:!1,ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i}),sanitizeText:input=>"string"!=typeof input?"":DOMPurify.sanitize(input,SecurityUtils.getDOMPurifyConfig()),sanitizeHTML:(input,allowedTags=["b","i","em","strong","br","span"])=>{if("string"!=typeof input)return"";const config={...SecurityUtils.getDOMPurifyConfig(),ALLOWED_TAGS:allowedTags,ALLOWED_ATTR:["class","style"],FORBID_ATTR:["onclick","onload","onerror","onmouseover"],FORBID_TAGS:["script","object","embed","applet","meta","link"]};return DOMPurify.sanitize(input,config)},setTextContent:(element,content)=>{element&&(element.textContent=SecurityUtils.sanitizeText(String(content)))},setHTMLContent:(element,content,allowedTags)=>{element&&(element.innerHTML=SecurityUtils.sanitizeHTML(String(content),allowedTags))},sanitizeAddress:address=>"string"!=typeof address?"":SecurityUtils.sanitizeText(address.replace(/[^0-9a-fA-Fx]/g,"")),sanitizeNumeric:value=>{if("number"==typeof value)return value;if("string"!=typeof value)return 0;const cleaned=value.replace(/[^0-9.-]/g,""),parsed=parseFloat(cleaned);return isNaN(parsed)?0:parsed},sanitizeTransactionId:txId=>"string"!=typeof txId?"":SecurityUtils.sanitizeText(txId.replace(/[^0-9a-fA-F]/g,""))};
        const CoreLogic = (()=>{const Constants={VALIDATION_PREFIX:"SADAT_V2_PART",MAX_IMAGE_DIMENSION:2e3,NUM_QR_CODES:9},Utils={preprocessImage:dataUrl=>new Promise(((resolve,reject)=>{const img=new Image;img.onload=()=>{const canvas=document.createElement("canvas");canvas.width=img.width,canvas.height=img.height;const ctx=canvas.getContext("2d");ctx.filter="grayscale(1) contrast(2.5) brightness(1.1)",ctx.drawImage(img,0,0),resolve(canvas.toDataURL("image/jpeg"))},img.onerror=reject,img.src=dataUrl})),resizeImage:(file,maxDimension)=>new Promise(((resolve,reject)=>{const reader=new FileReader;reader.onload=e=>{const img=new Image;img.onload=()=>{let{width:width,height:height}=img;width>height?width>maxDimension&&(height*=maxDimension/width,width=maxDimension):height>maxDimension&&(width*=maxDimension/height,height=maxDimension);const canvas=document.createElement("canvas");canvas.width=width,canvas.height=height,canvas.getContext("2d").drawImage(img,0,0,width,height),resolve(canvas.toDataURL("image/jpeg"))},img.onerror=reject,img.src=e.target.result},reader.onerror=reject,reader.readAsDataURL(file)}))},Banknote={getLayout:imageWidth=>{const standardWidth=790,scale=imageWidth/standardWidth;return{qrSize:Math.round(250*scale),xSpacing:Math.round(20*scale),ySpacing:Math.round(20*scale)}},decodeQrGrid:async(imageData,statusEl)=>{const layout=Banknote.getLayout(imageData.width),parts={};let count=0;const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=imageData.width,canvas.height=imageData.height,ctx.putImageData(imageData,0,0);for(let i=0;i<Constants.NUM_QR_CODES;i++){setStatus(statusEl,`Scanning section ${i+1}/${Constants.NUM_QR_CODES}...`,"info"),await new Promise((r=>setTimeout(r,5)));const row=Math.floor(i/3),col=i%3,regionX=col*(layout.qrSize+layout.xSpacing),regionY=row*(layout.qrSize+layout.ySpacing),data=ctx.getImageData(regionX,regionY,layout.qrSize,layout.qrSize),code=jsQR(data.data,data.width,data.height);if(code&&code.data.startsWith(Constants.VALIDATION_PREFIX)){const match=code.data.substring(Constants.VALIDATION_PREFIX.length).match(/^(\d+)\/(\d+):(.*)$/s);if(match){const partNum=parseInt(match[1],10);parts[partNum]||(parts[partNum]=match[3],count++)}}}if(count<Constants.NUM_QR_CODES)throw new Error(`Scan failed. Found ${count}/${Constants.NUM_QR_CODES} valid sections.`);let payload="";for(let i=1;i<=Constants.NUM_QR_CODES;i++)payload+=parts[i];return payload}};return{Constants,Utils,Banknote}})();
        const CacheManager={cache:new Map,DEFAULT_CACHE_DURATION:3e4,set(key,data,duration=this.DEFAULT_CACHE_DURATION){this.cache.set(key,{data:data,expiresAt:Date.now()+duration})},get(key){const cached=this.cache.get(key);return cached?(Date.now()>cached.expiresAt?(this.cache.delete(key),null):cached.data):null},invalidate(pattern){for(const key of this.cache.keys())key.includes(pattern)&&this.cache.delete(key)}};const NetworkOptimizer={getSyncStrategy:()=>{const speed=navigator.connection?.effectiveType||"4g";switch(speed){case"slow-2g":case"2g":return{interval:45e3,useCache:!0,cacheDuration:12e4};case"3g":return{interval:2e4,useCache:!0,cacheDuration:6e4};case"4g":default:return{interval:1e4,useCache:!0,cacheDuration:2e4}}}};
        const BackgroundSync={isRunning:!1,syncIntervalId:null,start(){if(this.isRunning)return;console.log("Starting background sync..."),this.isRunning=!0;const strategy=NetworkOptimizer.getSyncStrategy(),performSyncCycle=()=>{this.isRunning&&this.performSync().catch((err=>console.error("Background sync error:",err)))};performSyncCycle(),this.syncIntervalId=setInterval(performSyncCycle,strategy.interval)},async performSync(){if(!state.wallet)return void this.stop();const syncStatusEl=document.getElementById("sync-status");try{const[incomingTxs,outgoingTxs]=await Promise.all([SupabaseLedger.findIncomingTxs(state.wallet.address),SupabaseLedger.findOutgoingTxs(state.wallet.address)]);let newTxCount=0;for(const confirmation of incomingTxs)await WalletLogic.processDiscoveredTransaction(confirmation)&&newTxCount++;const balance=WalletLogic.calculateBalanceFromTxs(incomingTxs,outgoingTxs);state.currentBalance=balance,SecurityUtils.setTextContent(document.getElementById("balance-display"),`$${parseFloat(ethers.formatUnits(balance,state.config.PRECISION)).toFixed(2)}`),newTxCount>0&&(renderTransactionHistory(),syncStatusEl&&(setStatus(syncStatusEl,"âš¡ New transaction(s) detected!","success"),setTimeout((()=>{syncStatusEl&&setStatus(syncStatusEl,"")}),4e3)))}catch(error){console.error("Background sync failed:",error),syncStatusEl&&setStatus(syncStatusEl,"Sync failed. Retrying...","error")}},stop(){if(!this.isRunning)return;console.log("Stopping background sync..."),clearInterval(this.syncIntervalId),this.syncIntervalId=null,this.isRunning=!1}};
        const SupabaseLedger=(()=>{const apiCall=async(action,payload)=>{const response=await fetch(EDGE_FUNCTION_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${SUPABASE_ANON_KEY}`},body:JSON.stringify({action:action,payload:payload})}),result=await response.json();if(!response.ok||result.error)throw new Error(result.error||`Supabase API error! Status: ${response.status}`);return result.data};return{getAppConfig:()=>apiCall("getAppConfig"),prepareTransaction:(senderAddress,amount)=>apiCall("prepareTransaction",{senderAddress:senderAddress,amount:amount}),validateBanknote:banknotePayload=>apiCall("validateBanknote",{banknotePayload:banknotePayload}),recordSpentIdentifier:(identifier,type)=>apiCall("recordSpentIdentifier",{identifier:identifier,type:type}),hasBeenSpent:async identifier=>{try{const result=await apiCall("hasBeenSpent",{identifier:identifier});return result.spent}catch(error){return console.error("Failed to check identifier status on Supabase:",error),alert(`Critical Error: Could not read from the public ledger. Cannot verify transaction safety. Reason: ${error.message}`),!0}},pinConfirmation:confirmation=>apiCall("pinConfirmation",{confirmation:confirmation}),findConfirmation:txHash=>apiCall("findConfirmation",{txHash:txHash}),findIncomingTxs:async receiverAddress=>{const cacheKey=`incoming_${receiverAddress}`,strategy=NetworkOptimizer.getSyncStrategy();if(strategy.useCache){const cached=CacheManager.get(cacheKey);if(cached)return cached}const txs=await apiCall("findIncomingTxs",{receiverAddress:receiverAddress});return strategy.useCache&&CacheManager.set(cacheKey,txs,strategy.cacheDuration),txs},findOutgoingTxs:async senderAddress=>{const cacheKey=`outgoing_${senderAddress}`,strategy=NetworkOptimizer.getSyncStrategy();if(strategy.useCache){const cached=CacheManager.get(cacheKey);if(cached)return cached}const txs=await apiCall("findOutgoingTxs",{senderAddress:senderAddress});return strategy.useCache&&CacheManager.set(cacheKey,txs,strategy.cacheDuration),txs},getSpendDetails:identifier=>apiCall("getSpendDetails",{identifier:identifier}),findTransactionById:transactionId=>apiCall("findTransactionById",{transactionId:transactionId})}})();
        const AppConstants={MAX_LOGIN_ATTEMPTS:5,LOGIN_LOCKOUT_PERIOD:3e4,POLLING_INTERVAL:5e3,PAYMENT_REQUEST_EXPIRY:54e4,PRECISION:8};let state={wallet:null,userStore:null,failedLoginAttempts:0,isLockedOut:!1,activePaymentRequest:null,activeManualSend:null,activePollingTimer:null,cameraStream:null,isScannerActive:!1,currentBalance:0n,transactionIndex:new Map,config:null};
        const WalletLogic={createWallet:password=>{const wallet=ethers.Wallet.createRandom(),mnemonic=wallet.mnemonic.phrase,encryptedJson=wallet.encryptSync(password),genesisHash=ethers.id("GENESIS_BLOCK"),userStore={publicKey:wallet.publicKey,address:wallet.address,encryptedJson:encryptedJson,chain:[{id:parseInt(genesisHash.slice(-10),16),hash:genesisHash,type:"creation",timestamp:Date.now()}]};return localStorage.setItem("aura_user_store",JSON.stringify(userStore)),state.userStore=userStore,state.wallet=wallet,{mnemonic:mnemonic}},restoreWallet:async(mnemonic,password)=>{try{const wallet=ethers.Wallet.fromPhrase(mnemonic),encryptedJson=wallet.encryptSync(password),genesisHash=ethers.id("GENESIS_BLOCK"),userStore={publicKey:wallet.publicKey,address:wallet.address,encryptedJson:encryptedJson,chain:[{id:parseInt(genesisHash.slice(-10),16),hash:genesisHash,type:"creation",timestamp:Date.now()}]};return localStorage.setItem("aura_user_store",JSON.stringify(userStore)),state.userStore=userStore,state.wallet=wallet,!0}catch(e){return console.error("Restore failed:",e),!1}},login:async password=>{const userStoreJson=localStorage.getItem("aura_user_store");if(!userStoreJson)return null;try{const reloadedUserStore=JSON.parse(userStoreJson),wallet=await ethers.Wallet.fromEncryptedJson(reloadedUserStore.encryptedJson,password);return state.userStore=reloadedUserStore,state.wallet=wallet,state.failedLoginAttempts=0,WalletLogic.buildTransactionIndex(),!0}catch(e){return console.error("Login failed (likely incorrect password):",e),state.failedLoginAttempts++,!1}},logout:()=>{BackgroundSync.stop(),state.wallet=null,state.userStore=null,state.transactionIndex.clear()},buildTransactionIndex:()=>{state.transactionIndex.clear(),state.userStore&&state.userStore.chain&&state.userStore.chain.forEach((tx=>{const txKey=tx.linkedTxHash||tx.hash;state.transactionIndex.set(txKey,tx)}))},getLastTransaction:()=>state.userStore.chain[state.userStore.chain.length-1],addToChain:txData=>{const prevTx=WalletLogic.getLastTransaction(),newTx={...txData,prevHash:prevTx.hash,timestamp:txData.timestamp||Date.now()},amountInt=ethers.parseUnits((newTx.amount||0).toString(),state.config.PRECISION),feeInt=ethers.parseUnits((newTx.fee||0).toString(),state.config.PRECISION);newTx.hash=ethers.solidityPackedKeccak256(["string","uint256","uint256","string","string","string"],[newTx.type,amountInt,feeInt,newTx.from||"",newTx.to||"",newTx.prevHash]),txData.id?newTx.id=txData.id:newTx.id=parseInt(newTx.hash.slice(-10),16),state.userStore.chain.push(newTx),localStorage.setItem("aura_user_store",JSON.stringify(state.userStore));const txKey=newTx.linkedTxHash||newTx.hash;return state.transactionIndex.set(txKey,newTx),newTx},calculateBalanceFromTxs:(incomingTxs,outgoingTxs)=>{const precision=state.config.PRECISION;let incomingTotal=0n;incomingTxs.forEach((tx=>{incomingTotal+=ethers.parseUnits((Number(tx.amount)||0).toString(),precision)}));let outgoingTotal=0n;return outgoingTxs.forEach((tx=>{outgoingTotal+=ethers.parseUnits((Number(tx.amount)||0).toString(),precision)})),incomingTotal-outgoingTotal},getServerAuthoritativeBalance:async()=>{if(!state.userStore)return 0n;const[incomingTxs,outgoingTxs]=await Promise.all([SupabaseLedger.findIncomingTxs(state.wallet.address),SupabaseLedger.findOutgoingTxs(state.wallet.address)]),balance=WalletLogic.calculateBalanceFromTxs(incomingTxs,outgoingTxs);return state.currentBalance=balance,balance},getStandardizedConfirmationMessage:confirmation=>{const amount=Number(confirmation.amount).toFixed(state.config.PRECISION);return[confirmation.type,confirmation.senderAddress,confirmation.receiverAddress,amount,confirmation.linkedTxHash,confirmation.comment||""].join("|")},createPaymentRequest:amount=>{const receiveTx=WalletLogic.addToChain({type:"receive",amount:amount,from:"",to:state.wallet.address,status:"pending_request"});return{type:"AURA_PAYMENT_REQUEST",receiverAddress:state.wallet.address,amount:amount,linkedTxHash:receiveTx.hash,expiresAt:Date.now()+state.config.PAYMENT_REQUEST_EXPIRY}},processPayment:async(request,fee)=>{if(!state.config?.TREASURY_ADDRESS)throw new Error("CRITICAL: Treasury address is not configured.");if(Date.now()>request.expiresAt)throw new Error("Payment request has expired.");if(await SupabaseLedger.hasBeenSpent(request.linkedTxHash))throw new Error("This payment request has already been processed.");await SupabaseLedger.recordSpentIdentifier(request.linkedTxHash,"transaction");const mainTx=WalletLogic.addToChain({type:"send",amount:request.amount,fee:fee,from:state.wallet.address,to:request.receiverAddress,status:"completed",linkedTxHash:request.linkedTxHash}),confirmation={type:"AURA_PAYMENT_CONFIRMATION",senderAddress:state.wallet.address,receiverAddress:request.receiverAddress,amount:request.amount,linkedTxHash:request.linkedTxHash,id:mainTx.id},messageToSign=WalletLogic.getStandardizedConfirmationMessage(confirmation);confirmation.signature=await state.wallet.signMessage(messageToSign),confirmation.signedMessage=messageToSign,await SupabaseLedger.pinConfirmation(confirmation);const feeTx=WalletLogic.addToChain({type:"send",amount:fee,fee:0,from:state.wallet.address,to:state.config.TREASURY_ADDRESS,status:"completed",purpose:"fee"}),feeConfirmation={type:"AURA_PAYMENT_CONFIRMATION",senderAddress:state.wallet.address,receiverAddress:state.config.TREASURY_ADDRESS,amount:fee,linkedTxHash:feeTx.hash,id:feeTx.id},feeMessageToSign=WalletLogic.getStandardizedConfirmationMessage(feeConfirmation);return feeConfirmation.signature=await state.wallet.signMessage(feeMessageToSign),feeConfirmation.signedMessage=feeMessageToSign,await SupabaseLedger.pinConfirmation(feeConfirmation),CacheManager.invalidate(state.wallet.address),!0},directSend:async(recipientAddress,amount,comment,fee)=>{if(!state.config?.TREASURY_ADDRESS)throw new Error("CRITICAL: Treasury address is not configured.");const sendTx=WalletLogic.addToChain({type:"send",amount:amount,fee:fee,from:state.wallet.address,to:recipientAddress,status:"completed",comment:comment}),confirmation={type:"AURA_PAYMENT_CONFIRMATION",senderAddress:state.wallet.address,receiverAddress:recipientAddress,amount:amount,linkedTxHash:sendTx.hash,id:sendTx.id,comment:comment},messageToSign=WalletLogic.getStandardizedConfirmationMessage(confirmation);confirmation.signature=await state.wallet.signMessage(messageToSign),confirmation.signedMessage=messageToSign,await SupabaseLedger.pinConfirmation(confirmation);const feeTx=WalletLogic.addToChain({type:"send",amount:fee,fee:0,from:state.wallet.address,to:state.config.TREASURY_ADDRESS,status:"completed",purpose:"fee"}),feeConfirmation={type:"AURA_PAYMENT_CONFIRMATION",senderAddress:state.wallet.address,receiverAddress:state.config.TREASURY_ADDRESS,amount:fee,linkedTxHash:feeTx.hash,id:feeTx.id},feeMessageToSign=WalletLogic.getStandardizedConfirmationMessage(feeConfirmation);return feeConfirmation.signature=await state.wallet.signMessage(feeMessageToSign),feeConfirmation.signedMessage=feeMessageToSign,await SupabaseLedger.pinConfirmation(feeConfirmation),CacheManager.invalidate(state.wallet.address),!0},finalizePayment:async confirmation=>{const receiveTxIndex=state.userStore.chain.findIndex((tx=>tx.hash===confirmation.linkedTxHash&&"pending_request"===tx.status));if(-1===receiveTxIndex)return console.error("Finalize Error: Could not find pending transaction."),!1;if(!confirmation.signedMessage)return console.error("Finalize Error: Receipt is missing 'signedMessage'."),!1;const locallyRecreatedMessage=WalletLogic.getStandardizedConfirmationMessage(confirmation);if(locallyRecreatedMessage!==confirmation.signedMessage)return console.error("Tamper Detection: Confirmation data mismatch."),!1;const signerAddress=ethers.verifyMessage(confirmation.signedMessage,confirmation.signature);return signerAddress!==confirmation.senderAddress?(console.error("Signature verification failed!"),!1):(state.userStore.chain[receiveTxIndex].status="completed",state.userStore.chain[receiveTxIndex].from=confirmation.senderAddress,localStorage.setItem("aura_user_store",JSON.stringify(state.userStore)),CacheManager.invalidate(state.wallet.address),!0)},processDiscoveredTransaction:async confirmation=>{if(confirmation.receiverAddress!==state.wallet.address)return!1;const txKey=confirmation.linkedTxHash||confirmation.hash;if(state.userStore.chain.find((tx=>tx.linkedTxHash===txKey&&tx.from===confirmation.senderAddress&&tx.amount===confirmation.amount)))return!1;if("BANKNOTE_ISSUER"!==confirmation.senderAddress){if(!confirmation.signedMessage)return console.error("Discovered TX invalid: Missing 'signedMessage'"),!1;const locallyRecreatedMessage=WalletLogic.getStandardizedConfirmationMessage(confirmation);if(locallyRecreatedMessage!==confirmation.signedMessage)return console.error("Discovered TX failed tamper check"),!1;const signerAddress=ethers.verifyMessage(confirmation.signedMessage,confirmation.signature);if(signerAddress!==confirmation.senderAddress)return console.error("Discovered TX failed signature validation"),!1}return WalletLogic.addToChain({id:confirmation.id,type:"BANKNOTE_ISSUER"===confirmation.senderAddress?"charge":"receive",amount:confirmation.amount,from:confirmation.senderAddress,to:state.wallet.address,status:"completed",linkedTxHash:confirmation.linkedTxHash,timestamp:confirmation.timestamp,comment:confirmation.comment}),!0}};
        function setLoader(loaderId,isLoading){document.getElementById(loaderId).classList.toggle("hidden",!isLoading)}
        function setStatus(element,message,type=""){element&&(SecurityUtils.setTextContent(element,message),element.className="status-box",type&&element.classList.add(type))}
        function resetViewInputs(viewId){const view=document.getElementById(viewId);view&&(view.querySelectorAll("input, textarea").forEach((input=>{"file"!==input.type&&(input.value="")}));const statusBox=view.querySelector(".status-box");statusBox&&SecurityUtils.setTextContent(statusBox,""))}
        async function updateBalanceAndRender(){try{const balance=await WalletLogic.getServerAuthoritativeBalance(),balanceEl=document.getElementById("balance-display"),finalBalance=parseFloat(ethers.formatUnits(balance,state.config.PRECISION));animateCountUp(balanceEl,finalBalance),renderTransactionHistory()}catch(error){console.error("Could not update balance:",error),SecurityUtils.setTextContent(document.getElementById("balance-display"),"Error")}}
        function generateQrCode(data,containerId){const container=document.getElementById(containerId);container.innerHTML="";const qr=qrcode(0,"L");qr.addData(data),qr.make();const img=document.createElement("img"),imgTagString=qr.createImgTag(6,10),srcMatch=imgTagString.match(/src="([^"]+)"/),widthMatch=imgTagString.match(/width="([^"]+)"/),heightMatch=imgTagString.match(/height="([^"]+)"/);srcMatch&&(img.src=srcMatch[1]),widthMatch&&(img.width=widthMatch[1]),heightMatch&&(img.height=heightMatch[1]),img.alt="QR Code",container.appendChild(img)}
        function abbreviateAddress(address){if(!address)return"";const sanitized=SecurityUtils.sanitizeAddress(address);return`${sanitized.substring(0,6)}...${sanitized.substring(sanitized.length-4)}`}
        function stopScanner(){state.cameraStream&&(state.cameraStream.getTracks().forEach((track=>track.stop())),state.cameraStream=null,state.isScannerActive=!1)}
        async function startScanner(){if(state.isScannerActive||!document.getElementById("send-view").classList.contains("active"))return;state.isScannerActive=!0;const video=document.getElementById("qr-video"),canvasElement=document.getElementById("qr-canvas"),canvas=canvasElement.getContext("2d"),sendStatusEl=document.getElementById("send-status");setStatus(sendStatusEl,""),SecurityUtils.setTextContent(document.getElementById("loading-message"),"Requesting camera access...");try{state.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),video.srcObject=state.cameraStream,video.setAttribute("playsinline",!0),await video.play(),requestAnimationFrame(tick)}catch(err){console.error("Camera Error:",err),setStatus(sendStatusEl,"Camera access is required.","error"),state.isScannerActive=!1}function tick(){if(!state.isScannerActive)return;if(video.readyState===video.HAVE_ENOUGH_DATA){canvasElement.height=video.videoHeight,canvasElement.width=video.videoWidth,canvas.drawImage(video,0,0,canvasElement.width,canvasElement.height);const imageData=canvas.getImageData(0,0,canvasElement.width,canvasElement.height),code=jsQR(imageData.data,imageData.width,imageData.height,{inversionAttempts:"dontInvert"});if(code){stopScanner(),setStatus(sendStatusEl,"QR Code Detected! Processing...","info");let isPaymentRequest=!1;try{const request=JSON.parse(code.data);"AURA_PAYMENT_REQUEST"===request.type&&request.amount&&request.receiverAddress&&(isPaymentRequest=!0,Promise.resolve().then((async()=>{if(Date.now()>request.expiresAt)throw new Error("This payment request has expired.");if(await SupabaseLedger.hasBeenSpent(request.linkedTxHash))throw new Error("This payment request has already been paid.");setStatus(sendStatusEl,"Validating transaction with server...","info");const{fee:fee,totalDebit:totalDebit}=await SupabaseLedger.prepareTransaction(state.wallet.address,request.amount);state.activePaymentRequest={...request,fee:fee,total:totalDebit},state.activeManualSend=null;const confirmAmountEl=document.getElementById("confirm-amount-display"),confirmAmountHTML=`Amount: $${request.amount.toFixed(2)}<br><span style="font-size: 14px; opacity: 0.7;">Fee (${(100*state.config.FEE_PERCENTAGE).toFixed(1)}%): +$${fee.toFixed(2)}</span><br><strong style="font-size: 18px;">Total: $${totalDebit.toFixed(2)}</strong>`;SecurityUtils.setHTMLContent(confirmAmountEl,confirmAmountHTML,["br","span","strong"]),SecurityUtils.setTextContent(document.getElementById("confirm-recipient-address-display"),request.receiverAddress),await showView("send-confirm-view")})).catch((err=>{setStatus(sendStatusEl,err.message,"error"),setTimeout((()=>startScanner()),2e3)})))}catch(e){}if(!isPaymentRequest)if(ethers.isAddress(code.data))document.getElementById("send-address-input").value=code.data,setStatus(sendStatusEl,"Recipient address scanned! Please enter the amount to send.","success"),document.getElementById("send-amount-input").focus();else{setStatus(sendStatusEl,"Invalid QR Code. Not a valid address or payment request.","error"),setTimeout((()=>startScanner()),2e3)}return}}requestAnimationFrame(tick)}}
        function renderTransactionHistory(){const listUl=document.getElementById("transaction-list-ul");listUl.innerHTML="";if(!state.userStore||!state.userStore.chain)return;const transactions=state.userStore.chain.filter((tx=>("send"===tx.type||"receive"===tx.type||"charge"===tx.type)&&"completed"===tx.status)).slice(-10).reverse();if(0===transactions.length){const item=document.createElement("li");return item.className="no-transactions",SecurityUtils.setTextContent(item,"No transactions found."),void listUl.appendChild(item)}transactions.forEach(((tx,index)=>{const item=document.createElement("li");item.className="transaction-item",item.style.cursor="pointer",item.style.animationDelay=`${100*index}ms`;const isSent="send"===tx.type,typeText=isSent?"Sent":"charge"===tx.type?"Charge":"Received",typeClass=isSent?"sent":"received",totalAmount=parseFloat(tx.amount||0),date=new Date(tx.timestamp).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),iconDiv=document.createElement("div");iconDiv.className="tx-icon";const iconSVG=isSent?`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${typeClass}"><path d="M7 17L17 7M17 7H7M17 7V17"/></svg>`:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${typeClass}"><path d="M7 7L17 17M17 17H7M17 17V7"/></svg>`;iconDiv.innerHTML=iconSVG;const detailsDiv=document.createElement("div");detailsDiv.className="transaction-details";const typeSpan=document.createElement("span");typeSpan.className=`transaction-type ${typeClass}`,SecurityUtils.setTextContent(typeSpan,typeText);const dateSpan=document.createElement("span");dateSpan.className="transaction-date",SecurityUtils.setTextContent(dateSpan,date),detailsDiv.appendChild(typeSpan),detailsDiv.appendChild(dateSpan);const amountSpan=document.createElement("span");amountSpan.className=`transaction-amount ${typeClass}`,SecurityUtils.setTextContent(amountSpan,`${isSent?"-":"+"}$${totalAmount.toFixed(2)}`),item.appendChild(iconDiv),item.appendChild(detailsDiv),item.appendChild(amountSpan),item.addEventListener("click",(()=>showTransactionDetails(tx))),listUl.appendChild(item)}))}
        function showTransactionDetails(tx){const modal=document.getElementById("transaction-detail-modal"),contentEl=document.getElementById("modal-details-content"),confirmationData=tx.confirmation_data||tx,fromAddress=confirmationData.from&&ethers.isAddress(confirmationData.from)?confirmationData.from:"Invalid Address",toAddress=confirmationData.to&&ethers.isAddress(confirmationData.to)?confirmationData.to:"Invalid Address",amount=isNaN(parseFloat(confirmationData.amount))?0:parseFloat(confirmationData.amount),fee=isNaN(parseFloat(confirmationData.fee))?0:parseFloat(confirmationData.fee),detailsHTML=`\n        <p><strong>ID:</strong> <span>${SecurityUtils.sanitizeText(confirmationData.id||"N/A")}</span></p>\n        <p><strong>Status:</strong> <span>${SecurityUtils.sanitizeText(confirmationData.status||"N/A")}</span></p>\n        <p><strong>Type:</strong> <span>${SecurityUtils.sanitizeText(confirmationData.type||"N/A")}</span></p>\n        <p><strong>Date & Time:</strong> <span>${(new Date(confirmationData.timestamp)).toLocaleString("en-US",{dateStyle:"long",timeStyle:"medium"})}</span></p>\n        <p><strong>Amount:</strong> <span>$${amount.toFixed(2)}</span></p>\n        <p><strong>Fee:</strong> <span>$${fee.toFixed(2)}</span></p>\n        <p style="word-wrap: break-word;"><strong>From:</strong> <span>${SecurityUtils.sanitizeAddress(fromAddress)}</span></p>\n        <p style="word-wrap: break-word;"><strong>To:</strong> <span>${SecurityUtils.sanitizeAddress(toAddress)}</span></p>\n        <p style="word-wrap: break-word;"><strong>Comment:</strong> <span>${SecurityUtils.sanitizeText(confirmationData.comment||"N/A")}</span></p>\n        <p style="word-wrap: break-word;"><strong>Transaction Hash (TxID):</strong> <span>${SecurityUtils.sanitizeTransactionId("send"===confirmationData.type?confirmationData.hash:confirmationData.linkedTxHash||"N/A")}</span></p>\n    `;SecurityUtils.setHTMLContent(contentEl,detailsHTML,["p","strong","span"]),modal.style.display="flex",document.getElementById("close-modal-button").onclick=()=>{modal.style.display="none"},document.getElementById("download-tx-button").onclick=()=>{html2canvas(contentEl,{scale:2,backgroundColor:getComputedStyle(document.documentElement).getPropertyValue("--surface-color")}).then((canvas=>{const link=document.createElement("a");link.download=`transaction_${SecurityUtils.sanitizeTransactionId(confirmationData.linkedTxHash||confirmationData.hash).substring(0,10)}.jpg`,link.href=canvas.toDataURL("image/jpeg",.9),link.click()}))}}
        async function showView(id){document.getElementById("send-view").classList.contains("active")&&"send-view"!==id&&stopScanner(),state.activePollingTimer&&(clearInterval(state.activePollingTimer),state.activePollingTimer=null),document.querySelectorAll(".view").forEach((v=>v.classList.remove("active")));const viewElement=document.getElementById(id);viewElement&&(setTimeout((()=>viewElement.classList.add("active")),50),"wallet-view"===id?(document.getElementById("balance-display").textContent="...",state.wallet&&SecurityUtils.setTextContent(document.getElementById("address-display"),abbreviateAddress(state.wallet.address)),await updateBalanceAndRender(),BackgroundSync.start()):"send-view"===id?startScanner():"receive-view"===id&&(SecurityUtils.setTextContent(document.getElementById("full-receive-address"),state.wallet.address),generateQrCode(state.wallet.address,"static-qr-code")))}
        async function initializeApp(){try{const fetchedConfig=await SupabaseLedger.getAppConfig();state.config={...AppConstants,...fetchedConfig}}catch(e){return void alert(`Critical error initializing app configuration: ${e.message}`)}loadTheme(),localStorage.getItem("aura_user_store")?showView("login-view"):showView("onboarding-view"),setupEventListeners()}
        function setupEventListeners(){document.getElementById("go-to-create-wallet").addEventListener("click",(()=>showView("create-wallet-view"))),document.getElementById("go-to-restore-wallet").addEventListener("click",(()=>showView("restore-wallet-view"))),document.getElementById("back-from-create").addEventListener("click",(()=>{resetViewInputs("create-wallet-view"),showView("onboarding-view")})),document.getElementById("back-from-restore").addEventListener("click",(()=>{resetViewInputs("restore-wallet-view"),showView("onboarding-view")})),document.getElementById("back-from-send").addEventListener("click",(()=>{resetViewInputs("send-view"),showView("wallet-view")})),document.getElementById("create-wallet-button").addEventListener("click",(async()=>{const button=document.getElementById("create-wallet-button"),statusEl=document.getElementById("create-status"),pass=document.getElementById("create-password-input").value.trim(),confirmPass=document.getElementById("confirm-password-input").value.trim();if(setStatus(statusEl,""),pass.length<8)return void setStatus(statusEl,"Password must be at least 8 characters.","error");if(pass!==confirmPass)return void setStatus(statusEl,"Passwords do not match.","error");button.disabled=!0,setLoader("create-loader",!0),setTimeout((()=>{const{mnemonic:mnemonic}=WalletLogic.createWallet(pass);SecurityUtils.setTextContent(document.getElementById("seed-phrase-display"),mnemonic),showView("seed-phrase-view"),button.disabled=!1,setLoader("create-loader",!1)}),50)})),document.getElementById("seed-phrase-confirm-button").addEventListener("click",(async()=>{await showView("wallet-view"),SecurityUtils.setTextContent(document.getElementById("seed-phrase-display"),""),resetViewInputs("create-wallet-view")})),document.getElementById("restore-wallet-button").addEventListener("click",(async()=>{const button=document.getElementById("restore-wallet-button"),statusEl=document.getElementById("restore-status"),mnemonic=document.getElementById("restore-seed-input").value.trim(),pass=document.getElementById("restore-password-input").value.trim();if(setStatus(statusEl,""),12!==mnemonic.split(" ").length)return void setStatus(statusEl,"Recovery phrase must be 12 words.","error");if(pass.length<8)return void setStatus(statusEl,"Password must be at least 8 characters.","error");button.disabled=!0,setLoader("restore-loader",!0);const success=await WalletLogic.restoreWallet(mnemonic,pass);success?await showView("wallet-view"):setStatus(statusEl,"Restore failed. Invalid phrase.","error"),button.disabled=!1,setLoader("restore-loader",!1),resetViewInputs("restore-wallet-view")})),document.getElementById("login-button").addEventListener("click",(async()=>{if(state.isLockedOut)return;const button=document.getElementById("login-button"),statusEl=document.getElementById("login-status"),pass=document.getElementById("login-password-input").value.trim();button.disabled=!0,setLoader("login-loader",!0),setStatus(statusEl,"Decrypting wallet...","info");const success=await WalletLogic.login(pass);success?(await showView("wallet-view"),resetViewInputs("login-view")):state.failedLoginAttempts>=state.config.MAX_LOGIN_ATTEMPTS?(state.isLockedOut=!0,setStatus(statusEl,"Too many failed attempts. Please wait 30 seconds.","error"),setTimeout((()=>{state.isLockedOut=!1,state.failedLoginAttempts=0,setStatus(statusEl,""),button.disabled=!1}),state.config.LOGIN_LOCKOUT_PERIOD)):setStatus(statusEl,`Invalid password. (${state.config.MAX_LOGIN_ATTEMPTS-state.failedLoginAttempts} attempts remaining)`,"error"),state.isLockedOut||(button.disabled=!1),setLoader("login-loader",!1)})),document.getElementById("logout-button").addEventListener("click",(()=>{WalletLogic.logout(),showView("login-view")})),document.getElementById("reset-app-button").addEventListener("click",(()=>{confirm("Are you sure? All wallet data will be erased from this browser.")&&(localStorage.removeItem("aura_user_store"),location.reload())})),document.getElementById("copy-address-button").addEventListener("click",(()=>{const button=document.getElementById("copy-address-button");navigator.clipboard.writeText(state.wallet.address).then((()=>{button.textContent="Copied!",setTimeout((()=>{button.textContent="Copy"}),1500)}))})),document.getElementById("show-receive-view-button").addEventListener("click",(()=>{resetViewInputs("receive-view"),showView("receive-view")})),document.getElementById("show-send-view-button").addEventListener("click",(()=>{resetViewInputs("send-view"),showView("send-view")})),document.getElementById("show-charge-view-button").addEventListener("click",(()=>{resetViewInputs("charge-view"),showView("charge-view")})),document.getElementById("send-manual-button").addEventListener("click",(async event=>{const button=event.target,statusEl=document.getElementById("send-status"),recipientAddress=document.getElementById("send-address-input").value.trim(),amountStr=document.getElementById("send-amount-input").value,amount=parseFloat(amountStr),rawComment=document.getElementById("send-comment-input").value.trim();if(setStatus(statusEl,""),rawComment.length>50)return void setStatus(statusEl,"Comment cannot exceed 50 characters.","error");if(!ethers.isAddress(recipientAddress))return void setStatus(statusEl,"Invalid recipient address.","error");if(isNaN(amount)||amount<=0)return void setStatus(statusEl,"Please enter a valid amount.","error");const comment=SecurityUtils.sanitizeText(rawComment);button.disabled=!0,setStatus(statusEl,"Validating transaction with server...","info");try{const{fee:fee,totalDebit:totalDebit}=await SupabaseLedger.prepareTransaction(state.wallet.address,amount);state.activeManualSend={address:recipientAddress,amount:amount,comment:comment,fee:fee,total:totalDebit},state.activePaymentRequest=null;const confirmAmountEl=document.getElementById("confirm-amount-display"),confirmAmountHTML=`Amount: $${amount.toFixed(2)}<br><span style="font-size: 14px; opacity: 0.7;">Fee (${(100*state.config.FEE_PERCENTAGE).toFixed(1)}%): +$${fee.toFixed(2)}</span><br><strong style="font-size: 18px;">Total: $${totalDebit.toFixed(2)}</strong>`;SecurityUtils.setHTMLContent(confirmAmountEl,confirmAmountHTML,["br","span","strong"]),SecurityUtils.setTextContent(document.getElementById("confirm-recipient-address-display"),recipientAddress),SecurityUtils.setTextContent(document.getElementById("confirm-comment-display"),comment?`Comment: "${comment}"`:""),await showView("send-confirm-view")}catch(err){setStatus(statusEl,err.message,"error")}finally{button.disabled=!1}})),document.querySelectorAll(".theme-button").forEach((button=>{button.addEventListener("click",(e=>{applyTheme(e.target.dataset.theme)}))}))}
        document.addEventListener("DOMContentLoaded",initializeApp);
    </script>
</body>
</html>
