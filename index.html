<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon-1024 Quantum-Resistant Wallet</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #1a2b4d;
            border-bottom: 2px solid #e1e8ed;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        h1 {
            text-align: center;
            margin-top: 0;
        }
        .section {
            margin-bottom: 30px;
        }
        textarea, input[type="password"], button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 1rem;
            font-family: monospace;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        .secondary-button {
             background-color: #6c757d;
        }
        .secondary-button:hover {
             background-color: #5a6268;
        }
        .output-area {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-family: monospace;
            border: 1px solid #ced4da;
            min-height: 50px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }
        #status {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #28a745;
            height: 20px;
            transition: opacity 0.5s;
        }
        .error-message {
            display: none; 
            background-color: #ffdddd; 
            border: 1px solid #dc3545; 
            color: #721c24; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="error-message" class="error-message">
        <h2>⚠️ خطا: صفحه به درستی بارگیری نشده است</h2>
        <p>این کیف پول با باز کردن مستقیم فایل کار نمی‌کند (آدرس `file:///`).</p>
        <p><strong>برای حل مشکل، باید از یک سرور محلی استفاده کنید.</strong> لطفاً طبق دستورالعمل، یک سرور راه‌اندازی کرده و سپس آدرس <strong>http://localhost:8000</strong> را در مرورگر خود باز کنید.</p>
    </div>

    <div class="container">
        <h1>Falcon-1024 Quantum-Resistant Wallet 🦅</h1>

        <div id="status"></div>

        <div class="section">
            <h2>1. Create or Restore Wallet</h2>
            <label for="mnemonic">12-Word Seed Phrase:</label>
            <textarea id="mnemonic" placeholder="Enter your 12-word seed phrase to restore, or click generate."></textarea>
            <button id="generateMnemonicBtn" class="secondary-button">Generate 12-Word Mnemonic</button>
            <label for="passphrase">Optional Passphrase:</label>
            <input type="password" id="passphrase" placeholder="Enter an optional passphrase for added security.">
            <button id="deriveKeypairBtn">Derive Keypair from Mnemonic</button>
            <label>Derived Keys:</label>
            <div id="keypairOutput" class="output-area">Your public and private keys will appear here.</div>
        </div>

        <div class="section">
            <h2>2. Sign Message</h2>
            <label for="messageToSign">Message to Sign:</label>
            <textarea id="messageToSign" placeholder="Enter the message you want to sign with your private key."></textarea>
            <button id="signMessageBtn">Sign Message</button>
            <label>Signature:</label>
            <div id="signatureOutput" class="output-area">The generated signature will appear here.</div>
        </div>

        <div class="section">
            <h2>3. Verify Signature</h2>
            <label for="messageToVerify">Original Message:</label>
            <textarea id="messageToVerify" placeholder="Enter the original, unsigned message."></textarea>
            <label for="publicKeyToVerify">Public Key (Hex):</label>
            <textarea id="publicKeyToVerify" placeholder="Enter the public key that should have signed the message."></textarea>
            <label for="signatureToVerify">Signature (Hex):</label>
            <textarea id="signatureToVerify" placeholder="Enter the signature to verify."></textarea>
            <button id="verifyBtn">Verify Signature</button>
            <label>Verification Result:</label>
            <div id="verificationResult" class="output-area">The verification result will appear here.</div>
        </div>
    </div>

    <script>
        if (window.location.protocol === 'file:') {
            document.getElementById('error-message').style.display = 'block';
            document.querySelectorAll('button').forEach(btn => btn.disabled = true);
        }
    </script>

    <script type="module">
        import * as falconWallet from './falcon-wallet.browser (1).mjs';

        const statusDiv = document.getElementById('status');
        const showStatus = (message, isError = false, duration = 3000) => {
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? '#dc3545' : '#28a745';
            if (duration > 0) {
                setTimeout(() => statusDiv.textContent = '', duration);
            }
        };

        if (falconWallet) {
            console.log('✅ Falcon wallet library loaded successfully!');
            showStatus('Library loaded successfully!');
        }
        
        const mnemonicTextarea = document.getElementById('mnemonic');
        const passphraseInput = document.getElementById('passphrase');
        const generateMnemonicBtn = document.getElementById('generateMnemonicBtn');
        const deriveKeypairBtn = document.getElementById('deriveKeypairBtn');
        const keypairOutput = document.getElementById('keypairOutput');
        const messageToSign = document.getElementById('messageToSign');
        const signMessageBtn = document.getElementById('signMessageBtn');
        const signatureOutput = document.getElementById('signatureOutput');
        const messageToVerify = document.getElementById('messageToVerify');
        const publicKeyToVerify = document.getElementById('publicKeyToVerify');
        const signatureToVerify = document.getElementById('signatureToVerify');
        const verifyBtn = document.getElementById('verifyBtn');
        const verificationResult = document.getElementById('verificationResult');

        let currentKeypair = null;

        generateMnemonicBtn.addEventListener('click', () => {
            const newMnemonic = falconWallet.generateMnemonic(12);
            mnemonicTextarea.value = newMnemonic;
            keypairOutput.textContent = 'New mnemonic generated. Click "Derive Keypair" to create the wallet.';
            signatureOutput.textContent = '';
            currentKeypair = null;
        });

        deriveKeypairBtn.addEventListener('click', async () => {
            const mnemonic = mnemonicTextarea.value.trim();
            const passphrase = passphraseInput.value;
            if (!falconWallet.isValidMnemonic(mnemonic)) {
                keypairOutput.textContent = 'Error: Invalid Mnemonic Phrase. Please check for typos.';
                return;
            }
            showStatus('Deriving keypair... (this may take a moment)', false, 0);
            keypairOutput.textContent = '';
            try {
                currentKeypair = await falconWallet.deriveKeypair(mnemonic, passphrase);
                keypairOutput.innerHTML = 
                    `<strong>Public Key:</strong>\n${currentKeypair.publicKey}\n\n` +
                    `<strong>Private Key:</strong>\n<small>${currentKeypair.privateKey}</small>`;
                publicKeyToVerify.value = currentKeypair.publicKey;
                showStatus('✅ Keypair derived successfully!');
            } catch (error) {
                keypairOutput.textContent = `Error: ${error.message}`;
                showStatus('Derivation failed.', true);
            }
        });

        signMessageBtn.addEventListener('click', async () => {
            if (!currentKeypair) {
                signatureOutput.textContent = 'Error: Please derive a keypair first before signing.';
                return;
            }
            const message = messageToSign.value;
            if (!message) {
                 signatureOutput.textContent = 'Error: Please enter a message to sign.';
                return;
            }
            showStatus('Signing message...', false, 0);
            signatureOutput.textContent = '';
            try {
                const signature = await falconWallet.signMessage(message, currentKeypair.privateKey);
                signatureOutput.textContent = signature;
                messageToVerify.value = message;
                signatureToVerify.value = signature;
                showStatus('✅ Message signed successfully!');
            } catch (error) {
                signatureOutput.textContent = `Error: ${error.message}`;
                showStatus('Signing failed.', true);
            }
        });

        verifyBtn.addEventListener('click', async () => {
            const message = messageToVerify.value;
            const publicKey = publicKeyToVerify.value.trim();
            const signature = signatureToVerify.value.trim();
            if (!message || !publicKey || !signature) {
                verificationResult.textContent = 'Error: Please provide the original message, public key, and signature.';
                return;
            }
            showStatus('Verifying signature...', false, 0);
            verificationResult.textContent = '';
            try {
                const isValid = await falconWallet.verifyMessage(message, publicKey, signature);
                verificationResult.textContent = `Verification Result: ${isValid ? '✅ Valid Signature' : '❌ Invalid Signature'}`;
                showStatus('');
            } catch (error) {
                verificationResult.textContent = `Error: ${error.message}`;
                showStatus('Verification failed.', true);
            }
        });
    </script>
</body>
</html>
