<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: Ø­Ù„ Ù…Ø´Ú©Ù„ Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.9.3/sha3.min.js"></script>  <script src="falcon.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            padding: 20px; 
            background-color: #f4f7f9;
            color: #333;
            max-width: 850px; 
            margin: auto; 
            line-height: 1.6;
        }
        h2, h3 {
            color: #1a237e;
            border-bottom: 2px solid #c5cae9;
            padding-bottom: 10px;
        }
        textarea, input, button { 
            width: 100%; 
            padding: 12px; 
            margin-top: 10px; 
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button { 
            background-color: #3f51b5; 
            color: white; 
            border: none; 
            cursor: pointer; 
            transition: background-color 0.3s;
            position: relative;
        }
        button:hover:not(:disabled) { 
            background-color: #303f9f; 
        }
        button:disabled {
            background-color: #9fa8da;
            cursor: not-allowed;
        }
        .output-group {
            background: #fff; 
            padding: 15px; 
            margin-top: 15px; 
            border-radius: 6px; 
            border: 1px solid #e0e0e0;
            word-break: break-all; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .status { font-weight: bold; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
        .status.success { color: #1b5e20; background-color: #c8e6c9; }
        .status.error { color: #b71c1c; background-color: #ffcdd2; }
        .status.loading { color: #0d47a1; background-color: #bbdefb; }
        .troubleshooting {
            background-color: #fff9c4;
            border: 1px solid #fbc02d;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
        }
        code {
            background-color: #eee;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }
        .spinner {
            display: inline-block;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h2>Ø§Ù…Ø¶Ø§ Ø¨Ø§ Ed25519 + Falcon-512 + SHAKE256 (Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯)</h2>

    <div id="initStatus" class="status loading">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ...</div>
    <div id="troubleshootingArea" class="troubleshooting" style="display: none;"></div>

    <h3>Û±. ØªÙˆÙ„ÛŒØ¯ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
    <div class="output-group">
        <strong>Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Ed25519 (Base64):</strong>
        <div id="ed25519Pk">...</div>
        <hr>
        <strong>Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Falcon-512 (Base64):</strong>
        <div id="falconPk">...</div>
    </div>

    <h3>Û². Ù¾ÛŒØ§Ù… Ùˆ Ø§Ù…Ø¶Ø§</h3>
    <textarea id="message" rows="5" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
    <button id="signButton" disabled>ğŸ–‹ ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø¶Ø§</button>

    <div class="output-group">
        <strong>Ø§Ù…Ø¶Ø§ÛŒ Ed25519 (Base64):</strong>
        <div id="ed25519Sig"></div>
        <hr>
        <strong>Ø§Ù…Ø¶Ø§ÛŒ Falcon-512 (Base64):</strong>
        <div id="falconSig"></div>
    </div>
    
    <h3>Û³. Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù…Ø¶Ø§</h3>
    <button id="verifyButton" disabled>âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±</button>
    <div id="verifyResult" class="output-group" style="display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const dom = {
        initStatus: document.getElementById('initStatus'),
        troubleshootingArea: document.getElementById('troubleshootingArea'),
        signButton: document.getElementById('signButton'),
        verifyButton: document.getElementById('verifyButton'),
        ed25519Pk: document.getElementById('ed25519Pk'),
        falconPk: document.getElementById('falconPk'),
        ed25519Sig: document.getElementById('ed25519Sig'),
        falconSig: document.getElementById('falconSig'),
        verifyResult: document.getElementById('verifyResult'),
    };

    // --- State Management ---
    let state = {
        falcon: null,
        keys: { ed25519: null, falcon: null },
        signatures: { ed25519: null, falcon: null },
        messageHash: null,
        modulesLoaded: { ed25519: false, falcon: false, shake: false }
    };
    
    // --- Helper Functions ---
    const bytesToBase64 = (bytes) => btoa(String.fromCharCode(...bytes));
    const hexToBytes = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
    
    function setLoadingState(button, isLoading, originalText) {
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = `${originalText} <span class="spinner"></span>`;
        } else {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    function showTroubleshooting(errors) {
        dom.troubleshootingArea.style.display = 'block';
        dom.troubleshootingArea.innerHTML = `
            <h3>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„</h3>
            <p>ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ù…Ø§Ú˜ÙˆÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù†Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯:</p>
            <ul>
                <li><strong>Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª:</strong> Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù…ØªØµÙ„ Ù‡Ø³ØªÛŒØ¯ ØªØ§ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ed25519 Ùˆ SHAKE256 Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´ÙˆÙ†Ø¯.</li>
                <li><strong>Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„ <code>falcon.js</code>:</strong> Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÙØ§ÛŒÙ„ <code>falcon.js</code> Ø¯Ø± Ú©Ù†Ø§Ø± Ù‡Ù…ÛŒÙ† ÙØ§ÛŒÙ„ HTML Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.</li>
                <li><strong>Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú©Ù†Ø³ÙˆÙ„ Ù…Ø±ÙˆØ±Ú¯Ø±:</strong> Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ØŒ Ú©Ù„ÛŒØ¯ <b>F12</b> Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯ Ùˆ Ø¨Ù‡ ØªØ¨ <b>"Console"</b> Ø¨Ø±ÙˆÛŒØ¯. Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù‚Ø±Ù…Ø²Ø±Ù†Ú¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙÛŒØ¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯.</li>
            </ul>
            <p><strong>Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒâ€ŒØ´Ø¯Ù‡:</strong></p>
            <ul>${errors.map(e => `<li>${e}</li>`).join('')}</ul>
        `;
    }

    // --- Core Cryptographic Functions ---
    async function initialize() {
        const initEd25519 = new Promise((resolve, reject) => {
            try {
                if (typeof nacl === 'undefined') throw new Error("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ nacl (Ed25519) Ø§Ø² CDN Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                state.keys.ed25519 = nacl.sign.keyPair();
                state.modulesLoaded.ed25519 = true;
                resolve({ name: 'Ed25519', status: 'fulfilled' });
            } catch (e) {
                console.error('Ed25519 Init Error:', e);
                reject({ name: 'Ed25519', reason: e });
            }
        });
        
        const initFalcon = new Promise(async (resolve, reject) => {
            try {
                if (typeof pqcSignFalcon512 === 'undefined') throw new Error("ØªØ§Ø¨Ø¹ pqcSignFalcon512 (Falcon) Ø§Ø² ÙØ§ÛŒÙ„ falcon.js Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø¢ÛŒØ§ ÙØ§ÛŒÙ„ Ú©Ù†Ø§Ø± HTML Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯ØŸ");
                state.falcon = await pqcSignFalcon512();
                state.keys.falcon = await state.falcon.generateKeyPair();
                state.modulesLoaded.falcon = true;
                resolve({ name: 'Falcon-512', status: 'fulfilled' });
            } catch (e) {
                console.error('Falcon-512 Init Error:', e);
                reject({ name: 'Falcon-512', reason: e });
            }
        });

        // Test SHAKE256
        try {
            if (typeof sha3 === 'undefined') throw new Error("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ js-sha3 Ø§Ø² CDN Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
            sha3.shake256('', 1024);
            state.modulesLoaded.shake = true;
        } catch(e) {
            console.error('SHAKE256 Init Error:', e);
        }
        
        const results = await Promise.allSettled([initEd25519, initFalcon]);
        let allSuccess = true;
        let errorDetails = [];
        
        results.forEach(result => {
            if (result.status === 'rejected') {
                allSuccess = false;
                errorDetails.push(`<b>${result.reason.name}:</b> ${result.reason.reason.message}`);
            }
        });

        if (!state.modulesLoaded.shake) {
            allSuccess = false;
            errorDetails.push("<b>SHAKE256:</b> Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ js-sha3 Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        }

        if (allSuccess) {
            dom.initStatus.textContent = 'âœ… ØªÙ…Ø§Ù… Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ú©Ù„ÛŒØ¯Ù‡Ø§ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù†Ø¯.';
            dom.initStatus.className = 'status success';
            dom.ed25519Pk.textContent = bytesToBase64(state.keys.ed25519.publicKey);
            dom.falconPk.textContent = bytesToBase64(state.keys.falcon.publicKey);
            dom.signButton.disabled = false;
        } else {
            dom.initStatus.textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†ÛŒØ¯.';
            dom.initStatus.className = 'status error';
            showTroubleshooting(errorDetails);
            if (!state.modulesLoaded.ed25519) dom.ed25519Pk.textContent = 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚';
            if (!state.modulesLoaded.falcon) dom.falconPk.textContent = 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚';
        }
    }
    
    function hashMessage(msg) {
        if (!state.modulesLoaded.shake) return null;
        const hashHex = sha3.shake256(msg, 1024); 
        return hexToBytes(hashHex);
    }
    
    async function handleSign() {
        setLoadingState(dom.signButton, true, 'ğŸ–‹ ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø¶Ø§');
        dom.verifyButton.disabled = true;
        
        state.messageHash = hashMessage(dom.message.value);

        if (!state.messageHash) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ù‡Ø´ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…. Ø¹Ù…Ù„ÛŒØ§Øª Ù…ØªÙˆÙ‚Ù Ø´Ø¯.');
            setLoadingState(dom.signButton, false, 'ğŸ–‹ ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø¶Ø§');
            return;
        }
        
        if (state.modulesLoaded.ed25519) {
            const sig = nacl.sign.detached(state.messageHash, state.keys.ed25519.secretKey);
            state.signatures.ed25519 = sig;
            dom.ed25519Sig.textContent = bytesToBase64(sig);
        }
        
        if (state.modulesLoaded.falcon) {
            const sig = await state.falcon.sign(state.keys.falcon.privateKey, state.messageHash);
            state.signatures.falcon = sig;
            dom.falconSig.textContent = bytesToBase64(sig);
        }

        setLoadingState(dom.signButton, false, 'ğŸ–‹ ØªÙˆÙ„ÛŒØ¯ Ø§Ù…Ø¶Ø§');
        if (state.signatures.ed25519 && state.signatures.falcon) {
            dom.verifyButton.disabled = false;
        }
        dom.verifyResult.style.display = 'none';
    }
    
    async function handleVerify() {
        if (!state.messageHash || !state.signatures.ed25519 || !state.signatures.falcon) {
            alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø±Ø§ Ø§Ù…Ø¶Ø§ Ú©Ù†ÛŒØ¯.');
            return;
        }
        
        setLoadingState(dom.verifyButton, true, 'âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±');
        let resultsHTML = '';
        
        if (state.modulesLoaded.ed25519) {
            const isValid = nacl.sign.detached.verify(state.messageHash, state.signatures.ed25519, state.keys.ed25519.publicKey);
            resultsHTML += `<strong>Ed25519:</strong> ${isValid ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}<br>`;
        }
        
        if (state.modulesLoaded.falcon) {
            const isValid = await state.falcon.verify(state.keys.falcon.publicKey, state.messageHash, state.signatures.falcon);
            resultsHTML += `<strong>Falcon-512:</strong> ${isValid ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}`;
        }

        dom.verifyResult.innerHTML = resultsHTML;
        dom.verifyResult.style.display = 'block';
        setLoadingState(dom.verifyButton, false, 'âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±');
    }

    // --- Event Listeners ---
    dom.signButton.addEventListener('click', handleSign);
    dom.verifyButton.addEventListener('click', handleVerify);

    // --- Start Application ---
    initialize();
});
</script>
</body>
</html>
