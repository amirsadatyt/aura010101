<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Aura Wallet (Supabase Ledger)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        :root {
            --primary-color: #333333; --secondary-color: #000000; --danger-color: #d9534f;
            --light-gray: #f5f5f5; --dark-gray: #555555; --success-color: #1e8e3e;
            --text-light: #ffffff; --text-dark: #212529; --card-bg: #ffffff; --border-color: #dee2e6;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--light-gray); display: flex; justify-content: center;
        align-items: center; height: 100vh; margin: 0; color: var(--text-dark); }
        .view { display: none;
        }
        .view.active { display: block;
        }
        .card { background-color: var(--card-bg); padding: 30px; border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 380px; text-align: center; border-top: 5px solid var(--secondary-color);
        }
        input, textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px;
        border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; text-align: center; font-family: 'Roboto', sans-serif; background-color: #fff; color: #000;
        }
        textarea { resize: vertical; height: 80px;
        }
        button { width: 100%; padding: 12px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: var(--text-light);
        border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: all 0.2s;
        }
        button:hover { opacity: 0.9; transform: translateY(-2px);
        }
        button:disabled { background: #999; cursor: not-allowed; transform: translateY(0);
        }
        .back-button { background: var(--dark-gray); margin-top: 10px;
        }
        .logout-button { background: var(--danger-color); margin-top: 10px;
        }
        .link-button { background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer;
        padding: 5px; width: auto; }
        .status-box { font-weight: bold; min-height: 20px; margin-top: 10px;
        word-wrap: break-word; }
        .error { color: var(--danger-color);
        }
        .success { color: var(--success-color);
        }
        .info { color: #007bff;
        }
        .seed-phrase-box { padding: 15px; border: 1px dashed var(--danger-color); border-radius: 8px;
        margin: 20px 0; background-color: #fff8f8; color: #333; font-size: 18px; letter-spacing: 1px;
        }
        #my-qr-code img, #qr-display-box img, #static-qr-code img { margin: 15px auto; display: block;
        border: 5px solid #eee; border-radius: 5px; }
        label.qr-upload-label { cursor: pointer; display: block;
        margin: 15px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px;
        }
        label.qr-upload-label:hover { background-color: #f9f9f9;
        }
        input[type="file"] { display: none;
        }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color);
        width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; margin: 10px auto;
        }
        .loader.hidden { display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg);
        } }
        .transaction-history { margin-top: 25px; text-align: left;
        }
        .transaction-history h3 { text-align: center; margin-bottom: 15px; color: var(--secondary-color);
        }
        .transaction-list { list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto;
        }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 10px;
        border-bottom: 1px solid var(--border-color); }
        .transaction-item:last-child { border-bottom: none;
        }
        .transaction-details { display: flex; flex-direction: column;
        }
        .transaction-type { font-weight: bold; font-size: 16px;
        }
        .transaction-type.sent { color: var(--danger-color);
        }
        .transaction-type.received { color: var(--success-color);
        }
        .transaction-date { font-size: 12px; color: #888;
        }
        .transaction-amount { font-weight: bold; font-size: 16px;
        }
        .transaction-amount.sent { color: var(--danger-color);
        }
        .transaction-amount.received { color: var(--success-color);
        }
        .no-transactions { text-align: center; color: #999; padding: 20px;
        }
        .address-display-box { background: #f0f2f5; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: flex;
        align-items: center; justify-content: center; }
        .address-text { font-family: monospace; font-size: 14px; margin-right: 10px;
        }
        .copy-button { padding: 5px 10px; font-size: 12px; width: auto; background: var(--dark-gray);
        min-width: 60px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%;
        height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { width: 400px; max-width: 90%; text-align: left; padding: 25px;
        }
        .modal-content h2 { text-align: center; margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div id="onboarding-view" class="view active"><div class="card"><h1>Aura Wallet</h1><p>A new generation of asset security and control</p><button id="go-to-create-wallet">Create a New Wallet</button><button id="go-to-restore-wallet" class="back-button">Restore Wallet</button></div></div>
    <div id="create-wallet-view" class="view"><div class="card"><h2>Create Password</h2><p>Choose a strong password to encrypt your wallet.
    This password cannot be recovered.</p><input type="password" id="create-password-input" placeholder="Password"><input type="password" id="confirm-password-input" placeholder="Confirm Password"><div class="loader hidden" id="create-loader"></div><button id="create-wallet-button">Create Wallet</button><div id="create-status" class="status-box"></div><button class="back-button" id="back-from-create">Back</button></div></div>
    <div id="seed-phrase-view" class="view"><div class="card"><h2>Your Recovery Phrase</h2><p class="error">Write down these 12 words in a safe, offline place.
    This is the only way to recover your wallet.</p><div id="seed-phrase-display" class="seed-phrase-box"></div><button id="seed-phrase-confirm-button">I Understand, Take Me to My Wallet</button></div></div>
    <div id="restore-wallet-view" class="view"><div class="card"><h2>Restore Wallet</h2><p>Enter your 12-word recovery phrase.</p><textarea id="restore-seed-input" placeholder="Enter words separated by spaces..."></textarea><p>Choose a new password for this device.</p><input type="password" id="restore-password-input" placeholder="New Password"><div class="loader hidden" id="restore-loader"></div><button id="restore-wallet-button">Restore</button><div id="restore-status" class="status-box"></div><button class="back-button" id="back-from-restore">Back</button></div></div>
    <div id="login-view" class="view"><div class="card"><h1>Unlock Wallet</h1><p>Enter your password to decrypt your wallet.</p><input type="password" id="login-password-input" placeholder="Password"><div class="loader hidden" id="login-loader"></div><button id="login-button">Unlock</button><div id="login-status" class="status-box"></div><p style="margin-top:20px;">Want to use a different wallet?
    <button class="link-button" id="reset-app-button">Erase everything and start over</button></p></div></div>
    <div id="wallet-view" class="view"><div class="card"><h2>Your Wallet</h2><div class="address-display-box"><span id="address-display" class="address-text"></span><button id="copy-address-button" class="copy-button">Copy</button></div><p>Balance:</p><h1 id="balance-display">$0.00</h1><div id="sync-status" class="status-box" style="font-size: 14px;"></div><p id="network-status" style="font-size: 12px; color: var(--success-color);">Ledger: Supabase</p><button id="show-charge-view-button">Charge with Banknote</button><button id="show-send-view-button" style="margin-top:10px;">Send (Aura)</button><button id="show-receive-view-button" style="margin-top:10px;">Receive (Aura)</button><div class="transaction-history"><h3>Recent Transactions</h3><div class="search-container" style="margin-bottom: 10px; display: flex;"><input type="text" id="search-tx-id-input" placeholder="Search by Transaction ID" style="margin-bottom: 0; border-radius: 6px 0 0 6px;"><button id="search-tx-id-button" style="width: auto; padding: 10px; border-radius: 0 6px 6px 0;">Search</button></div><ul id="transaction-list-ul" class="transaction-list"></ul></div><button id="logout-button" class="logout-button">Logout (Lock Wallet)</button></div></div>
    <div id="charge-view" class="view"><div class="card"><h2>Charge Wallet</h2><p>Upload a digital banknote image to validate it and add the funds to your balance.</p><label for="banknote-image-input" class="qr-upload-label" id="banknote-upload-label">Upload Banknote Image</label>
    <input type="file" id="banknote-image-input" accept="image/jpeg,image/png,image/webp">
    <div id="validation-status" class="status-box"></div><div id="charge-confirmation" style="display:none;
    margin-top: 20px;"><p>Validation successful! Amount: <b id="validated-amount"></b></p><button id="confirm-charge-button">Add to Balance</button></div><button class="back-button" id="back-from-charge">Back</button></div></div>
    <div id="receive-view" class="view"><div class="card"><h2>Receive Funds</h2><p>Share your address to receive funds.</p><div id="static-qr-code"></div><p style="font-size: 12px;
    word-wrap: break-word; background: #f0f2f5; padding: 8px; border-radius: 4px;" id="full-receive-address"></p><hr style="margin: 20px 0;"><p>Or request a specific amount:</p><input type="number" id="request-amount-input" placeholder="Amount to receive"><button id="create-request-qr-button">Generate Payment Request QR</button><div id="receive-status" class="status-box"></div><button class="back-button" id="back-from-receive">Back</button></div></div>
    <div id="send-view" class="view"><div class="card"><h2>Send Funds</h2><p>Enter recipient address and amount.</p><div>
        <input type="text" id="send-address-input" placeholder="Recipient's Aura Address" style="margin-bottom: 10px;">
        <input type="number" id="send-amount-input" placeholder="Amount to send" style="margin-bottom: 10px;">
        <input type="text" id="send-comment-input" placeholder="Short comment (optional)" maxlength="50" style="margin-bottom: 5px;">
        <p id="comment-char-count" style="text-align: right; font-size: 12px; color: #888; margin-top: 0; margin-bottom: 10px;">0 / 50</p>
        <button id="send-manual-button">Continue</button>
    </div><p style="text-align:center;
    margin: 20px 0; font-weight: bold;">- OR -</p><p>Scan a recipient's payment request QR code.</p><div id="video-container" style="position: relative; width: 100%; max-width: 300px;
    margin: 15px auto; border-radius: 8px; overflow: hidden; border: 2px solid #333; background: #000;"><video id="qr-video" playsinline style="width: 100%; height: auto;
    display: block;"></video><div id="loading-message" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: flex;
    align-items: center; justify-content: center;">Requesting camera access...</div></div><canvas id="qr-canvas" style="display: none;"></canvas><div id="send-status" class="status-box"></div><button class="back-button" id="back-from-send">Back</button></div></div>
    <div id="send-confirm-view" class="view"><div class="card"><h2>Confirm Payment</h2><p>You are about to send:</p><h2 id="confirm-amount-display" style="color: var(--primary-color);"></h2><p>To:</p><p id="confirm-recipient-address-display" style="font-size: 12px;
    word-wrap: break-word; background: #f0f2f5; padding: 8px; border-radius: 4px;"></p>
    <p style="font-style: italic; color: #555; word-wrap: break-word;" id="confirm-comment-display"></p>
    <button id="confirm-payment-button">Confirm and Pay</button><div id="send-confirm-status" class="status-box"></div><button class="back-button" id="back-from-send-confirm">Cancel</button></div></div>
    <div id="qr-display-view" class="view"><div class="card"><h2 id="qr-display-title"></h2><p id="qr-display-instruction"></p><div id="qr-display-box"></div><div id="waiting-on-payment" style="display: none;"><div id="payment-timer"></div><div class="loader"></div><p id="final-status-message" class="status-box" style="font-size:18px;"></p></div><button class="back-button" id="back-from-qr-display">Back to Wallet</button></div></div>
    <div id="transaction-detail-modal" class="modal-overlay" style="display:none;"><div class="modal-content card"><h2>Transaction Details</h2><div id="modal-details-content"><p><strong>ID:</strong> <span id="detail-id"></span></p><p><strong>Status:</strong> <span id="detail-status"></span></p><p><strong>Type:</strong> <span id="detail-type"></span></p><p><strong>Date & Time:</strong> <span id="detail-datetime"></span></p><p><strong>Amount:</strong> <span id="detail-amount"></span></p><p><strong>Fee:</strong> <span id="detail-fee"></span></p><p style="word-wrap: break-word;"><strong>From:</strong> <span id="detail-from"></span></p><p style="word-wrap: break-word;"><strong>To:</strong> <span id="detail-to"></span></p>
    <p style="word-wrap: break-word;"><strong>Comment:</strong> <span id="detail-comment"></span></p>
    <p style="word-wrap: break-word;"><strong>Transaction Hash (TxID):</strong> <span id="detail-linked-hash"></span></p><p style="word-wrap: break-word;"><strong>Local Receipt Hash:</strong> <span id="detail-local-hash"></span></p></div><button id="download-tx-button">Download as JPG</button><button id="close-modal-button" class="back-button">Close</button></div></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="pako.min.js"></script>
    <script src="qrcode.js"></script>
    <script src="jsQR.js"></script>
    
    <script src="crypto-js.min.js"></script>
    <script src="html2canvas.min.js"></script>
    
    <script type="module">

// Polyfill Buffer if not available (for Edge/Supabase/browser environments)
if (typeof globalThis.Buffer === 'undefined') {
  globalThis.Buffer = {
    from: (input, encoding) => {
      if (encoding === 'base64') {
        const binary = atob(input);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        return bytes;
      }
      return new TextEncoder().encode(input);
    }
  };
}

        import { ethers } from "./ethers.min.js";
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://hdvqbcjtublfuykigsui.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkdnFiY2p0dWJsZnV5a2lnc3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTk4OTAsImV4cCI6MjA3MTUzNTg5MH0.Gog9zohe1bz6gihtssCBPUYkfNMbAjuQKR4Qvb3HNOg';
        const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/api`;

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- SECURITY UTILITIES (DOMPURIFY) ---
        const SecurityUtils = {
            getDOMPurifyConfig: () => ({ ALLOWED_TAGS: [], ALLOWED_ATTR: [] }),
            sanitizeText: (input) => DOMPurify.sanitize(input, SecurityUtils.getDOMPurifyConfig()),
            sanitizeHTML: (input, allowedTags = ['b', 'i', 'em', 'strong', 'br']) => DOMPurify.sanitize(input, { ...SecurityUtils.getDOMPurifyConfig(), ALLOWED_TAGS: allowedTags }),
            setTextContent: (element, content) => { if (element) element.textContent = SecurityUtils.sanitizeText(String(content)); },
            setHTMLContent: (element, content, allowedTags) => { if (element) element.innerHTML = SecurityUtils.sanitizeHTML(String(content), allowedTags); },
            sanitizeAddress: (address) => SecurityUtils.sanitizeText(String(address).replace(/[^0-9a-fA-Fx]/g, '')),
            sanitizeNumeric: (value) => { const parsed = parseFloat(String(value).replace(/[^0-9.-]/g, '')); return isNaN(parsed) ? 0 : parsed; },
            sanitizeTransactionId: (txId) => SecurityUtils.sanitizeText(String(txId).replace(/[^0-9a-fA-F]/g, '')),
        };

        // --- CORE BANKNOTE CLIENT-SIDE LOGIC ---
        const CoreLogic = (() => {
            const Constants = { VALIDATION_PREFIX: "SADAT_V2_PART", MAX_IMAGE_DIMENSION: 2000, NUM_QR_CODES: 9 };
            const Utils = {
                preprocessImage: (dataUrl) => new Promise((resolve, reject) => {
                     const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.filter = 'grayscale(1) contrast(2.5) brightness(1.1)';
                        ctx.drawImage(img, 0, 0);
                         resolve(canvas.toDataURL('image/jpeg'));
                    };
                    img.onerror = reject;
                    img.src = dataUrl;
                }),
                resizeImage: (file, maxDimension) => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let { width, height } = img;
                            if (width > maxDimension) { height *= maxDimension / width; width = maxDimension; }
                            else if (height > maxDimension) { width *= maxDimension / height; height = maxDimension; }
                            canvas.width = width;
                            canvas.height = height;
                            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg'));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }),
            };
            const Banknote = {
                getLayout: (imageWidth) => {
                    const scale = imageWidth / 790;
                    return { qrSize: Math.round(250 * scale), xSpacing: Math.round(20 * scale), ySpacing: Math.round(20 * scale) };
                },
                decodeQrGrid: async (imageData, statusEl) => {
                    const layout = Banknote.getLayout(imageData.width);
                    const parts = {};
                    let count = 0;
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = imageData.width; canvas.height = imageData.height;
                    ctx.putImageData(imageData, 0, 0);
                    for (let i = 0; i < Constants.NUM_QR_CODES; i++) {
                        setStatus(statusEl, `Scanning section ${i + 1}/${Constants.NUM_QR_CODES}...`, 'info');
                        await new Promise(r => setTimeout(r, 5));
                        const row = Math.floor(i / 3), col = i % 3;
                        const regionX = col * (layout.qrSize + layout.xSpacing), regionY = row * (layout.qrSize + layout.ySpacing);
                        const data = ctx.getImageData(regionX, regionY, layout.qrSize, layout.qrSize);
                        const code = jsQR(data.data, data.width, data.height);
                        if (code && code.data.startsWith(Constants.VALIDATION_PREFIX)) {
                            const match = code.data.substring(Constants.VALIDATION_PREFIX.length).match(/^(\d+)\/(\d+):(.*)$/s);
                            if (match) {
                                const partNum = parseInt(match[1], 10);
                                if (!parts[partNum]) { parts[partNum] = match[3]; count++; }
                            }
                        }
                    }
                    if (count < Constants.NUM_QR_CODES) throw new Error(`Scan failed. Found ${count}/${Constants.NUM_QR_CODES} valid sections.`);
                    let payload = '';
                    for (let i = 1; i <= Constants.NUM_QR_CODES; i++) payload += parts[i];
                    return payload;
                }
            };
            return { Constants, Utils, Banknote };
        })();
        
        const CacheManager = { cache: new Map(), set(key, data, duration = 30000) { this.cache.set(key, { data, expiresAt: Date.now() + duration }); }, get(key) { const c=this.cache.get(key); if(!c || Date.now()>c.expiresAt){this.cache.delete(key);return null;} return c.data;}, invalidate(p){for(const k of this.cache.keys()){if(k.includes(p)){this.cache.delete(k);}}}};
        const NetworkOptimizer = { getSyncStrategy:() => ({ interval: 10000, useCache: true, cacheDuration: 20000 }) };
        const BackgroundSync = { isRunning: false, syncIntervalId: null, start() {if(this.isRunning)return;this.isRunning=true;const s=NetworkOptimizer.getSyncStrategy();const c=()=>{if(!this.isRunning)return;this.performSync().catch(e=>console.error("BG sync err:",e));};c();this.syncIntervalId=setInterval(c,s.interval);}, async performSync(){if(!state.wallet){this.stop();return;}const e=document.getElementById('sync-status');try{const[i,o]=await Promise.all([SupabaseLedger.findIncomingTxs(state.wallet.address),SupabaseLedger.findOutgoingTxs(state.wallet.address)]);let t=0;for(const c of i){if(await WalletLogic.processDiscoveredTransaction(c)){t++;}}const n=WalletLogic.calculateBalanceFromTxs(i,o);state.currentBalance=n;SecurityUtils.setTextContent(document.getElementById('balance-display'),`$${parseFloat(ethers.formatUnits(n,state.config.PRECISION)).toFixed(2)}`);if(t>0){renderTransactionHistory();if(e){setStatus(e,'âš¡ New transaction(s) detected!','success');setTimeout(()=>{if(e)setStatus(e,'');},4000);}}}catch(r){console.error("BG sync failed:",r);if(e)setStatus(e,'Sync failed. Retrying...','error');}}, stop(){if(!this.isRunning)return;clearInterval(this.syncIntervalId);this.syncIntervalId=null;this.isRunning=false;}};
        
        const SupabaseLedger = (() => {
            const apiCall = async (action, payload) => {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error || !session) {
                    WalletLogic.logout();
                    showView('login-view');
                    setStatus(document.getElementById('login-status'), 'Your session has expired. Please log in again.', 'error');
                    throw new Error("User session not found or expired.");
                }
                const accessToken = session.access_token;
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                    body: JSON.stringify({ action, payload })
                });
                const result = await response.json();
                if (!response.ok || result.error) {
                    if (response.status === 429) throw new Error("You're doing that too quickly. Please wait a moment and try again.");
                    throw new Error(result.error || `Supabase API error! Status: ${response.status}`);
                }
                return result.data;
            };
            return {
                getAppConfig: () => { /* Special case for anon access */
                    return fetch(EDGE_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
                        body: JSON.stringify({ action: 'getAppConfig' })
                    }).then(res => res.json()).then(res => { if (res.error) throw new Error(res.error); return res.data; });
                },
                prepareTransaction:(a,b)=>apiCall('prepareTransaction',{senderAddress:a,amount:b}),
                validateBanknote:(p)=>apiCall('validateBanknote',{banknotePayload:p}),
                recordSpentIdentifier:(i,t)=>apiCall('recordSpentIdentifier',{identifier:i,type:t}),
                hasBeenSpent:async(i)=>{try{const r=await apiCall('hasBeenSpent',{identifier:i});return r.spent;}catch(e){alert(`Critical Error: Could not verify transaction safety. Reason: ${e.message}`);return true;}},
                pinConfirmation:(c)=>apiCall('pinConfirmation',{confirmation:c}),
                findConfirmation:(h)=>apiCall('findConfirmation',{txHash:h}),
                findIncomingTxs:async(r)=>{const k=`incoming_${r}`;const c=CacheManager.get(k);if(c)return c;const t=await apiCall('findIncomingTxs',{receiverAddress:r});CacheManager.set(k,t);return t;},
                findOutgoingTxs:async(s)=>{const k=`outgoing_${s}`;const c=CacheManager.get(k);if(c)return c;const t=await apiCall('findOutgoingTxs',{senderAddress:s});CacheManager.set(k,t);return t;},
                getSpendDetails:(i)=>apiCall('getSpendDetails',{identifier:i}),
                findTransactionById:(i)=>apiCall('findTransactionById',{transactionId:i})
            };
        })();

        const AppConstants = { MAX_LOGIN_ATTEMPTS: 5, LOGIN_LOCKOUT_PERIOD: 30000, POLLING_INTERVAL: 5000, PAYMENT_REQUEST_EXPIRY: 9*60*1000, PRECISION: 8, MAX_TX_SIZE_BYTES: 5*1024 };
        let state = { wallet: null, userStore: null, failedLoginAttempts: 0, isLockedOut: false, activePaymentRequest: null, activeManualSend: null, activePollingTimer: null, cameraStream: null, isScannerActive: false, currentBalance: 0n, transactionIndex: new Map(), config: null };
        
        const WalletLogic = {
            createWallet: async (password) => {
                const wallet = ethers.Wallet.createRandom();
                const encryptedJson = wallet.encryptSync(password);
                const email = `${wallet.address}@wallet.aura`;
                const { error } = await supabase.auth.signUp({ email, password: encryptedJson });
                if (error) throw new Error(`Could not create a secure server account: ${error.message}`);
                
                const userStore = { publicKey: wallet.publicKey, address: wallet.address, encryptedJson, chain: [{ id: parseInt(ethers.id("GENESIS_BLOCK").slice(-10), 16), hash: ethers.id("GENESIS_BLOCK"), type: 'creation', timestamp: Date.now() }] };
                localStorage.setItem('aura_user_store', JSON.stringify(userStore));
                state.userStore = userStore;
                state.wallet = wallet;
                return { mnemonic: wallet.mnemonic.phrase };
            },
            restoreWallet: async (mnemonic, password) => {
                const wallet = ethers.Wallet.fromPhrase(mnemonic);
                const encryptedJson = wallet.encryptSync(password);
                const email = `${wallet.address}@wallet.aura`;

                let { error } = await supabase.auth.signUp({ email, password: encryptedJson });
                if (error && error.message.includes('User already registered')) {
                    const { error: signInError } = await supabase.auth.signInWithPassword({ email, password: encryptedJson });
                    if (signInError) throw signInError;
                } else if (error) {
                    throw error;
                }
                
                const userStore = { publicKey: wallet.publicKey, address: wallet.address, encryptedJson, chain: [{ id: parseInt(ethers.id("GENESIS_BLOCK").slice(-10), 16), hash: ethers.id("GENESIS_BLOCK"), type: 'creation', timestamp: Date.now() }] };
                localStorage.setItem('aura_user_store', JSON.stringify(userStore));
                state.userStore = userStore;
                state.wallet = wallet;
                return true;
            },
            login: async (password) => {
                const userStoreJson = localStorage.getItem('aura_user_store');
                if (!userStoreJson) return null;
                const reloadedUserStore = JSON.parse(userStoreJson);
                const wallet = await ethers.Wallet.fromEncryptedJson(reloadedUserStore.encryptedJson, password);
                
                const email = `${wallet.address}@wallet.aura`;
                const { error } = await supabase.auth.signInWithPassword({ email, password: reloadedUserStore.encryptedJson });
                if (error) throw new Error(`Could not establish a secure session: ${error.message}. Please check your password.`);

                state.userStore = reloadedUserStore;
                state.wallet = wallet;
                state.failedLoginAttempts = 0;
                WalletLogic.buildTransactionIndex();
                return true;
            },
            logout: () => {
                BackgroundSync.stop();
                supabase.auth.signOut();
                state.wallet = null;
                state.userStore = null;
                state.transactionIndex.clear();
            },
            buildTransactionIndex:()=>{state.transactionIndex.clear();if(!state.userStore||!state.userStore.chain)return;state.userStore.chain.forEach(t=>{const k=t.linkedTxHash||t.hash;state.transactionIndex.set(k,t);});},
            getLastTransaction:()=>state.userStore.chain[state.userStore.chain.length-1],
            addToChain:(t)=>{const p=WalletLogic.getLastTransaction();const n={...t,prevHash:p.hash,timestamp:t.timestamp||Date.now()};const a=ethers.parseUnits((n.amount||0).toString(),state.config.PRECISION);const f=ethers.parseUnits((n.fee||0).toString(),state.config.PRECISION);n.hash=ethers.solidityPackedKeccak256(['string','uint256','uint256','string','string','string'],[n.type,a,f,n.from||'',n.to||'',n.prevHash]);if(t.id){n.id=t.id;}else{n.id=parseInt(n.hash.slice(-10),16);}state.userStore.chain.push(n);localStorage.setItem('aura_user_store',JSON.stringify(state.userStore));const k=n.linkedTxHash||n.hash;state.transactionIndex.set(k,n);return n;},
            calculateBalanceFromTxs:(i,o)=>{const p=state.config.PRECISION;let n=0n;i.forEach(t=>{n+=ethers.parseUnits((Number(t.amount)||0).toString(),p);});let s=0n;o.forEach(t=>{s+=ethers.parseUnits((Number(t.amount)||0).toString(),p);});return n-s;},
            getServerAuthoritativeBalance:async()=>{if(!state.userStore)return 0n;const[i,o]=await Promise.all([SupabaseLedger.findIncomingTxs(state.wallet.address),SupabaseLedger.findOutgoingTxs(state.wallet.address)]);const b=WalletLogic.calculateBalanceFromTxs(i,o);state.currentBalance=b;return b;},
            getStandardizedConfirmationMessage:(c)=>{const a=Number(c.amount).toFixed(state.config.PRECISION);return[c.type,c.senderAddress,c.receiverAddress,a,c.linkedTxHash,c.comment||''].join('|');},
            createPaymentRequest:(a)=>{const t=WalletLogic.addToChain({type:'receive',amount:a,from:'',to:state.wallet.address,status:'pending_request'});return{type:'AURA_PAYMENT_REQUEST',receiverAddress:state.wallet.address,amount:a,linkedTxHash:t.hash,expiresAt:Date.now()+state.config.PAYMENT_REQUEST_EXPIRY};},
            processPayment:async(r,f)=>{if(!state.config?.TREASURY_ADDRESS)throw new Error("CRITICAL: Treasury address is not configured.");if(Date.now()>r.expiresAt)throw new Error("Payment request has expired.");if(await SupabaseLedger.hasBeenSpent(r.linkedTxHash))throw new Error("This payment request has already been processed.");await SupabaseLedger.recordSpentIdentifier(r.linkedTxHash,'transaction');const m=WalletLogic.addToChain({type:'send',amount:r.amount,fee:f,from:state.wallet.address,to:r.receiverAddress,status:'completed',linkedTxHash:r.linkedTxHash});const c={type:'AURA_PAYMENT_CONFIRMATION',senderAddress:state.wallet.address,receiverAddress:r.receiverAddress,amount:r.amount,linkedTxHash:r.linkedTxHash,id:m.id};if(JSON.stringify(c).length>state.config.MAX_TX_SIZE_BYTES)throw new Error("Transaction is too large.");const s=WalletLogic.getStandardizedConfirmationMessage(c);c.signature=await state.wallet.signMessage(s);c.signedMessage=s;await SupabaseLedger.pinConfirmation(c);const t=WalletLogic.addToChain({type:'send',amount:f,fee:0,from:state.wallet.address,to:state.config.TREASURY_ADDRESS,status:'completed',purpose:'fee'});const e={type:'AURA_PAYMENT_CONFIRMATION',senderAddress:state.wallet.address,receiverAddress:state.config.TREASURY_ADDRESS,amount:f,linkedTxHash:t.hash,id:t.id};const g=WalletLogic.getStandardizedConfirmationMessage(e);e.signature=await state.wallet.signMessage(g);e.signedMessage=g;await SupabaseLedger.pinConfirmation(e);CacheManager.invalidate(state.wallet.address);return true;},
            directSend:async(r,a,m,f)=>{if(!state.config?.TREASURY_ADDRESS)throw new Error("CRITICAL: Treasury address is not configured.");const s=WalletLogic.addToChain({type:'send',amount:a,fee:f,from:state.wallet.address,to:r,status:'completed',comment:m});const c={type:'AURA_PAYMENT_CONFIRMATION',senderAddress:state.wallet.address,receiverAddress:r,amount:a,linkedTxHash:s.hash,id:s.id,comment:m};if(JSON.stringify(c).length>state.config.MAX_TX_SIZE_BYTES)throw new Error("Transaction is too large. Please shorten the comment.");const g=WalletLogic.getStandardizedConfirmationMessage(c);c.signature=await state.wallet.signMessage(g);c.signedMessage=g;await SupabaseLedger.pinConfirmation(c);const t=WalletLogic.addToChain({type:'send',amount:f,fee:0,from:state.wallet.address,to:state.config.TREASURY_ADDRESS,status:'completed',purpose:'fee'});const e={type:'AURA_PAYMENT_CONFIRMATION',senderAddress:state.wallet.address,receiverAddress:state.config.TREASURY_ADDRESS,amount:f,linkedTxHash:t.hash,id:t.id};const o=WalletLogic.getStandardizedConfirmationMessage(e);e.signature=await state.wallet.signMessage(o);e.signedMessage=o;await SupabaseLedger.pinConfirmation(e);CacheManager.invalidate(state.wallet.address);return true;},
            finalizePayment:async(c)=>{const i=state.userStore.chain.findIndex(t=>t.hash===c.linkedTxHash&&t.status==='pending_request');if(i===-1)return false;if(!c.signedMessage)return false;const l=WalletLogic.getStandardizedConfirmationMessage(c);if(l!==c.signedMessage)return false;const s=ethers.verifyMessage(c.signedMessage,c.signature);if(s!==c.senderAddress)return false;state.userStore.chain[i].status='completed';state.userStore.chain[i].from=c.senderAddress;localStorage.setItem('aura_user_store',JSON.stringify(state.userStore));CacheManager.invalidate(state.wallet.address);return true;},
            processDiscoveredTransaction:async(c)=>{if(c.receiverAddress!==state.wallet.address)return false;const k=c.linkedTxHash||c.hash;const e=state.userStore.chain.find(t=>t.linkedTxHash===k&&t.from===c.senderAddress&&t.amount===c.amount);if(e)return false;if(c.senderAddress!=='BANKNOTE_ISSUER'){if(!c.signedMessage)return false;const l=WalletLogic.getStandardizedConfirmationMessage(c);if(l!==c.signedMessage)return false;const s=ethers.verifyMessage(c.signedMessage,c.signature);if(s!==c.senderAddress)return false;}WalletLogic.addToChain({id:c.id,type:c.senderAddress==='BANKNOTE_ISSUER'?'charge':'receive',amount:c.amount,from:c.senderAddress,to:state.wallet.address,status:'completed',linkedTxHash:c.linkedTxHash,timestamp:c.timestamp,comment:c.comment});return true;}
        };
        
        // ... (The rest of your event listeners and UI functions remain unchanged)

        function setLoader(loaderId, isLoading) { document.getElementById(loaderId).classList.toggle('hidden', !isLoading); }
        function setStatus(element, message, type = '') { if (!element) return; SecurityUtils.setTextContent(element, message); element.className = 'status-box'; if (type) element.classList.add(type); }
        function resetViewInputs(viewId) { const view=document.getElementById(viewId); if(!view)return; view.querySelectorAll('input, textarea').forEach(i=>{if(i.type!=='file')i.value='';});const s=view.querySelector('.status-box');if(s)SecurityUtils.setTextContent(s,'');}
        async function updateBalanceAndRender() { try {const b=await WalletLogic.getServerAuthoritativeBalance();SecurityUtils.setTextContent(document.getElementById('balance-display'),`$${parseFloat(ethers.formatUnits(b,state.config.PRECISION)).toFixed(2)}`);renderTransactionHistory();}catch(e){console.error("Could not update balance:",e);SecurityUtils.setTextContent(document.getElementById('balance-display'),'Error');}}
        function generateQrCode(d,c){const e=document.getElementById(c);e.innerHTML='';const q=qrcode(0,'L');q.addData(d);q.make();const i=document.createElement('img');const t=q.createImgTag(6,10);const s=t.match(/src="([^"]+)"/),w=t.match(/width="([^"]+)"/),h=t.match(/height="([^"]+)"/);if(s)i.src=s[1];if(w)i.width=w[1];if(h)i.height=h[1];i.alt="QR Code";e.appendChild(i);}
        function abbreviateAddress(a){if(!a)return'';const s=SecurityUtils.sanitizeAddress(a);return`${s.substring(0,6)}...${s.substring(s.length-4)}`;}
        function stopScanner(){if(state.cameraStream){state.cameraStream.getTracks().forEach(t=>t.stop());state.cameraStream=null;state.isScannerActive=false;}}
        async function startScanner(){if(state.isScannerActive||!document.getElementById('send-view').classList.contains('active'))return;state.isScannerActive=true;const v=document.getElementById('qr-video'),l=document.getElementById('loading-message'),c=document.getElementById('qr-canvas'),a=c.getContext('2d'),s=document.getElementById('send-status');setStatus(s,'');l.style.display='flex';SecurityUtils.setTextContent(l,'Requesting camera access...');try{state.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});v.srcObject=state.cameraStream;v.setAttribute("playsinline",true);await v.play();l.style.display='none';requestAnimationFrame(tick);}catch(e){console.error("Camera Error:",e);SecurityUtils.setTextContent(l,'Could not access camera.');setStatus(s,'Camera access is required.','error');state.isScannerActive=false;}function tick(){if(!state.isScannerActive)return;if(v.readyState===v.HAVE_ENOUGH_DATA){c.height=v.videoHeight;c.width=v.videoWidth;a.drawImage(v,0,0,c.width,c.height);const i=a.getImageData(0,0,c.width,c.height);const o=jsQR(i.data,i.width,i.height,{inversionAttempts:"dontInvert"});if(o){stopScanner();setStatus(s,'QR Code Detected! Processing...','info');let p=false;try{const r=JSON.parse(o.data);if(r.type==='AURA_PAYMENT_REQUEST'&&r.amount&&r.receiverAddress){p=true;Promise.resolve().then(async()=>{if(Date.now()>r.expiresAt)throw new Error("This payment request has expired.");if(await SupabaseLedger.hasBeenSpent(r.linkedTxHash))throw new Error("This payment request has already been paid.");setStatus(s,'Validating transaction with server...','info');const{fee:f,totalDebit:t}=await SupabaseLedger.prepareTransaction(state.wallet.address,r.amount);state.activePaymentRequest={...r,fee:f,total:t};state.activeManualSend=null;const e=document.getElementById('confirm-amount-display');const h=`Amount: $${r.amount.toFixed(2)}<br><span style="font-size: 14px; color: #555;">Fee (${(state.config.FEE_PERCENTAGE*100).toFixed(1)}%): +$${f.toFixed(2)}</span><br><strong style="font-size: 18px;">Total: $${t.toFixed(2)}</strong>`;SecurityUtils.setHTMLContent(e,h,['br','span','strong']);SecurityUtils.setTextContent(document.getElementById('confirm-recipient-address-display'),r.receiverAddress);await showView('send-confirm-view');}).catch(e=>{setStatus(s,e.message,'error');setTimeout(()=>startScanner(),2000);});}}catch(e){}if(!p){if(ethers.isAddress(o.data)){document.getElementById('send-address-input').value=o.data;setStatus(s,'Recipient address scanned! Please enter the amount to send.','success');document.getElementById('send-amount-input').focus();}else{setStatus(s,'Invalid QR Code. Not a valid address or payment request.','error');setTimeout(()=>startScanner(),2000);}}return;}}requestAnimationFrame(tick);}}
        async function showView(id){if(document.getElementById('send-view').classList.contains('active')&&id!=='send-view')stopScanner();if(state.activePollingTimer){clearInterval(state.activePollingTimer);state.activePollingTimer=null;}document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));const e=document.getElementById(id);if(e)e.classList.add('active');if(id==='wallet-view'){SecurityUtils.setTextContent(document.getElementById('balance-display'),'Loading...');if(state.wallet)SecurityUtils.setTextContent(document.getElementById('address-display'),abbreviateAddress(state.wallet.address));await updateBalanceAndRender();BackgroundSync.start();}if(id==='send-view'){startScanner();}if(id==='receive-view'){SecurityUtils.setTextContent(document.getElementById('full-receive-address'),state.wallet.address);generateQrCode(state.wallet.address,'static-qr-code');}}
        function renderTransactionHistory(){const l=document.getElementById('transaction-list-ul');l.innerHTML='';if(!state.userStore||!state.userStore.chain)return;const t=state.userStore.chain.filter(tx=>(tx.type==='send'||tx.type==='receive'||tx.type==='charge')&&tx.status==='completed').slice(-10).reverse();if(t.length===0){const i=document.createElement('li');i.className='no-transactions';SecurityUtils.setTextContent(i,'No transactions found.');l.appendChild(i);return;}t.forEach(tx=>{const i=document.createElement('li');i.className='transaction-item';i.style.cursor='pointer';const s=tx.type==='send';const p=s?'Sent':(tx.comment||(tx.type==='charge'?'Charge':'Received'));const c=s?'sent':'received';const a=SecurityUtils.sanitizeNumeric(tx.amount||0);const d=new Date(tx.timestamp).toLocaleString('en-US');const v=document.createElement('div');v.className='transaction-details';const y=document.createElement('span');y.className=`transaction-type ${c}`;SecurityUtils.setTextContent(y,p);const e=document.createElement('span');e.className='transaction-date';SecurityUtils.setTextContent(e,d);v.appendChild(y);v.appendChild(e);const m=document.createElement('span');m.className=`transaction-amount ${c}`;SecurityUtils.setTextContent(m,`${s?'-':'+'}$${a.toFixed(2)}`);i.appendChild(v);i.appendChild(m);i.addEventListener('click',()=>showTransactionDetails(tx));l.appendChild(i);});}
        function showTransactionDetails(tx){const m=document.getElementById('transaction-detail-modal');const d=tx.confirmation_data||tx;const f=d.from&&ethers.isAddress(d.from)?d.from:'Invalid Address';const t=d.to&&ethers.isAddress(d.to)?d.to:'Invalid Address';const a=!isNaN(parseFloat(d.amount))?parseFloat(d.amount):0;const e=!isNaN(parseFloat(d.fee))?parseFloat(d.fee):0;SecurityUtils.setTextContent(document.getElementById('detail-id'),d.id||'N/A');SecurityUtils.setTextContent(document.getElementById('detail-status'),d.status||'N/A');SecurityUtils.setTextContent(document.getElementById('detail-type'),d.type||'N/A');SecurityUtils.setTextContent(document.getElementById('detail-datetime'),new Date(d.timestamp).toLocaleString('en-US',{dateStyle:'long',timeStyle:'medium'}));SecurityUtils.setTextContent(document.getElementById('detail-amount'),`$${a.toFixed(2)}`);SecurityUtils.setTextContent(document.getElementById('detail-fee'),`$${e.toFixed(2)}`);SecurityUtils.setTextContent(document.getElementById('detail-from'),f);SecurityUtils.setTextContent(document.getElementById('detail-to'),t);SecurityUtils.setTextContent(document.getElementById('detail-comment'),d.comment||'N/A');const l=document.getElementById('detail-linked-hash'),o=document.getElementById('detail-local-hash');if(d.type==='send'||(f===state.wallet.address&&d.purpose!=='fee')){SecurityUtils.setTextContent(l,SecurityUtils.sanitizeTransactionId(d.hash||'N/A'));document.getElementById('detail-local-hash').closest('p').style.display='none';}else{SecurityUtils.setTextContent(l,SecurityUtils.sanitizeTransactionId(d.linkedTxHash||'N/A'));SecurityUtils.setTextContent(o,SecurityUtils.sanitizeTransactionId(d.hash||'N/A'));document.getElementById('detail-local-hash').closest('p').style.display='block';}m.style.display='flex';document.getElementById('close-modal-button').onclick=()=>{m.style.display='none';};document.getElementById('download-tx-button').onclick=()=>{const c=document.getElementById('modal-details-content');html2canvas(c,{scale:2}).then(n=>{const l=document.createElement('a');l.download=`transaction_${SecurityUtils.sanitizeTransactionId((d.linkedTxHash||d.hash)).substring(0,10)}.jpg`;l.href=n.toDataURL('image/jpeg',0.9);l.click();});};}
        async function initializeApp(){try{const c=await SupabaseLedger.getAppConfig();state.config={...AppConstants,...c};}catch(e){alert(`Critical error initializing app configuration: ${e.message}`);return;}if(localStorage.getItem('aura_user_store')){showView('login-view');}else{showView('onboarding-view');}setupEventListeners();}
        function setupEventListeners(){document.getElementById('go-to-create-wallet').addEventListener('click',()=>showView('create-wallet-view'));document.getElementById('go-to-restore-wallet').addEventListener('click',()=>showView('restore-wallet-view'));document.getElementById('back-from-create').addEventListener('click',()=>{resetViewInputs('create-wallet-view');showView('onboarding-view');});document.getElementById('back-from-restore').addEventListener('click',()=>{resetViewInputs('restore-wallet-view');showView('onboarding-view');});document.getElementById('back-from-charge').addEventListener('click',()=>showView('wallet-view'));document.getElementById('back-from-receive').addEventListener('click',()=>showView('wallet-view'));document.getElementById('back-from-send').addEventListener('click',()=>{resetViewInputs('send-view');showView('wallet-view');});document.getElementById('back-from-send-confirm').addEventListener('click',()=>showView('send-view'));document.getElementById('back-from-qr-display').addEventListener('click',()=>{showView('wallet-view');});document.getElementById('create-wallet-button').addEventListener('click',async()=>{const b=document.getElementById('create-wallet-button'),s=document.getElementById('create-status');const p=document.getElementById('create-password-input').value.trim(),c=document.getElementById('confirm-password-input').value.trim();setStatus(s,'');if(p.length<8){setStatus(s,'Password must be at least 8 characters.','error');return;}if(p!==c){setStatus(s,'Passwords do not match.','error');return;}b.disabled=true;setLoader('create-loader',true);try{const{mnemonic}=await WalletLogic.createWallet(p);SecurityUtils.setTextContent(document.getElementById('seed-phrase-display'),mnemonic);showView('seed-phrase-view');}catch(e){setStatus(s,e.message,'error');}finally{b.disabled=false;setLoader('create-loader',false);}});document.getElementById('seed-phrase-confirm-button').addEventListener('click',async()=>{await showView('wallet-view');SecurityUtils.setTextContent(document.getElementById('seed-phrase-display'),'');resetViewInputs('create-wallet-view');});document.getElementById('restore-wallet-button').addEventListener('click',async()=>{const b=document.getElementById('restore-wallet-button'),s=document.getElementById('restore-status');const m=document.getElementById('restore-seed-input').value.trim(),p=document.getElementById('restore-password-input').value.trim();setStatus(s,'');if(m.split(' ').length!==12){setStatus(s,'Recovery phrase must be 12 words.','error');return;}if(p.length<8){setStatus(s,'Password must be at least 8 characters.','error');return;}b.disabled=true;setLoader('restore-loader',true);try{const success=await WalletLogic.restoreWallet(m,p);if(success){await showView('wallet-view');}else{setStatus(s,'Restore failed. Invalid phrase.','error');}}catch(e){setStatus(s,`Restore failed: ${e.message}`,'error');}finally{b.disabled=false;setLoader('restore-loader',false);resetViewInputs('restore-wallet-view');}});document.getElementById('login-button').addEventListener('click',async()=>{if(state.isLockedOut)return;const b=document.getElementById('login-button'),s=document.getElementById('login-status');const p=document.getElementById('login-password-input').value.trim();b.disabled=true;setLoader('login-loader',true);setStatus(s,'Decrypting wallet & logging in...','info');try{const success=await WalletLogic.login(p);if(success){await showView('wallet-view');resetViewInputs('login-view');}else{if(state.failedLoginAttempts>=state.config.MAX_LOGIN_ATTEMPTS){state.isLockedOut=true;setStatus(s,'Too many failed attempts. Please wait 30 seconds.','error');setTimeout(()=>{state.isLockedOut=false;state.failedLoginAttempts=0;setStatus(s,'');b.disabled=false;},state.config.LOGIN_LOCKOUT_PERIOD);}else{setStatus(s,`Invalid password. (${state.config.MAX_LOGIN_ATTEMPTS-state.failedLoginAttempts} attempts remaining)`,'error');}}}catch(e){setStatus(s,e.message,'error');}finally{if(!state.isLockedOut)b.disabled=false;setLoader('login-loader',false);}});document.getElementById('logout-button').addEventListener('click',()=>{WalletLogic.logout();showView('login-view');});document.getElementById('reset-app-button').addEventListener('click',()=>{if(confirm('Are you sure? All wallet data will be erased from this browser.')){localStorage.removeItem('aura_user_store');location.reload();}});document.getElementById('copy-address-button').addEventListener('click',()=>{const b=document.getElementById('copy-address-button');navigator.clipboard.writeText(state.wallet.address).then(()=>{SecurityUtils.setTextContent(b,'Copied!');setTimeout(()=>{SecurityUtils.setTextContent(b,'Copy');},1500);});});document.getElementById('show-receive-view-button').addEventListener('click',()=>{resetViewInputs('receive-view');showView('receive-view');});document.getElementById('show-send-view-button').addEventListener('click',()=>{resetViewInputs('send-view');showView('send-view');});document.getElementById('send-comment-input').addEventListener('input',(e)=>{const c=e.target.value.length;SecurityUtils.setTextContent(document.getElementById('comment-char-count'),`${c} / 50`);});document.getElementById('send-manual-button').addEventListener('click',async(e)=>{const b=e.target;const s=document.getElementById('send-status');const r=document.getElementById('send-address-input').value.trim();const a=parseFloat(document.getElementById('send-amount-input').value);const c=document.getElementById('send-comment-input').value.trim();setStatus(s,'');if(c.length>50){setStatus(s,'Comment cannot exceed 50 characters.','error');return;}if(!ethers.isAddress(r)){setStatus(s,'Invalid recipient address.','error');return;}if(isNaN(a)||a<=0){setStatus(s,'Please enter a valid amount.','error');return;}const m=SecurityUtils.sanitizeText(c);b.disabled=true;setStatus(s,'Validating transaction with server...','info');try{const{fee:f,totalDebit:t}=await SupabaseLedger.prepareTransaction(state.wallet.address,a);state.activeManualSend={address:r,amount:a,comment:m,fee:f,total:t};state.activePaymentRequest=null;const d=document.getElementById('confirm-amount-display');const h=`Amount: $${a.toFixed(2)}<br><span style="font-size: 14px; color: #555;">Fee (${(state.config.FEE_PERCENTAGE*100).toFixed(1)}%): +$${f.toFixed(2)}</span><br><strong style="font-size: 18px;">Total: $${t.toFixed(2)}</strong>`;SecurityUtils.setHTMLContent(d,h,['br','span','strong']);SecurityUtils.setTextContent(document.getElementById('confirm-recipient-address-display'),r);SecurityUtils.setTextContent(document.getElementById('confirm-comment-display'),m?`Comment: "${m}"`:'');await showView('send-confirm-view');}catch(err){setStatus(s,err.message,'error');}finally{b.disabled=false;}});document.getElementById('search-tx-id-button').addEventListener('click',async()=>{const b=document.getElementById('search-tx-id-button');const i=document.getElementById('search-tx-id-input').value.trim();if(!i){renderTransactionHistory();return;}const l=state.userStore.chain.find(t=>t.id&&t.id.toString()===i);if(l){showTransactionDetails(l);return;}b.disabled=true;SecurityUtils.setTextContent(b,'...');try{const s=await SupabaseLedger.findTransactionById(i);if(s){const d={id:s.id,status:'completed',type:s.senderAddress==='BANKNOTE_ISSUER'?'charge':(s.senderAddress===state.wallet.address?'send':'receive'),timestamp:s.timestamp,amount:s.amount,fee:0,from:s.senderAddress,to:s.receiverAddress,hash:s.hash,linkedTxHash:s.linkedTxHash,comment:s.comment};showTransactionDetails(d);}else{alert('Transaction not found on the server.');}}catch(e){console.error("Server search failed:",e);alert(`Error searching server: ${e.message}`);}finally{b.disabled=false;SecurityUtils.setTextContent(b,'Search');}});document.getElementById('create-request-qr-button').addEventListener('click',()=>{const a=parseFloat(document.getElementById('request-amount-input').value);const s=document.getElementById('receive-status');if(isNaN(a)||a<=0){setStatus(s,'Please enter a valid amount.','error');return;}const r=WalletLogic.createPaymentRequest(a);SecurityUtils.setTextContent(document.getElementById('qr-display-title'),'Payment Request');SecurityUtils.setTextContent(document.getElementById('qr-display-instruction'),`Show this QR to the sender to pay $${a.toFixed(2)}.`);document.getElementById('qr-display-box').style.display='block';generateQrCode(JSON.stringify(r),'qr-display-box');document.getElementById('waiting-on-payment').style.display='block';const m=document.getElementById('final-status-message'),t=document.getElementById('payment-timer');setStatus(m,'Waiting for sender to pay...','info');document.querySelector('#waiting-on-payment .loader').style.display='block';showView('qr-display-view');let l=state.config.PAYMENT_REQUEST_EXPIRY;const u=()=>{l-=1000;const n=Math.floor(l/60000),s=Math.floor((l%60000)/1000).toString().padStart(2,'0');SecurityUtils.setTextContent(t,`Expires in: ${n}:${s}`);if(l<=0){clearInterval(state.activePollingTimer);state.activePollingTimer=null;setStatus(m,'Payment request expired.','error');document.querySelector('#waiting-on-payment .loader').style.display='none';}};u();state.activePollingTimer=setInterval(async()=>{u();if(l<=0)return;try{const c=await SupabaseLedger.findConfirmation(r.linkedTxHash);if(c){clearInterval(state.activePollingTimer);state.activePollingTimer=null;t.style.display='none';setStatus(m,'Payment detected! Finalizing...','info');if(await WalletLogic.finalizePayment(c)){setStatus(m,`Success! $${Number(c.amount).toFixed(2)} received.`,'success');document.querySelector('#waiting-on-payment .loader').style.display='none';setTimeout(async()=>{await showView('wallet-view');},2000);}}}catch(e){console.error("Polling error:",e);setStatus(m,'Network error while checking for payment.','error');clearInterval(state.activePollingTimer);state.activePollingTimer=null;}},state.config.POLLING_INTERVAL);});document.getElementById('confirm-payment-button').addEventListener('click',async(e)=>{const b=e.target,s=document.getElementById('send-confirm-status');b.disabled=true;setStatus(s,'Processing payment...','info');try{await WalletLogic.getServerAuthoritativeBalance();let u=false,m='';if(state.activePaymentRequest){await WalletLogic.processPayment(state.activePaymentRequest,state.activePaymentRequest.fee);m=`Payment of $${state.activePaymentRequest.amount.toFixed(2)} sent!`;u=true;}else if(state.activeManualSend){await WalletLogic.directSend(state.activeManualSend.address,state.activeManualSend.amount,state.activeManualSend.comment,state.activeManualSend.fee);m=`Payment of $${state.activeManualSend.amount.toFixed(2)} sent!`;u=true;}else{throw new Error("No active payment request.");}if(u){setStatus(s,m,'success');await BackgroundSync.performSync();await new Promise(r=>setTimeout(r,1500));state.activePaymentRequest=null;state.activeManualSend=null;await showView('wallet-view');}}catch(err){setStatus(s,`Payment Failed: ${err.message}`,'error');}finally{b.disabled=false;}});document.getElementById('show-charge-view-button').addEventListener('click',()=>{resetViewInputs('charge-view');document.getElementById('charge-confirmation').style.display='none';const c=document.getElementById('confirm-charge-button');c.disabled=true;c.removeAttribute('data-amount');c.removeAttribute('data-serial');showView('charge-view');});document.getElementById('confirm-charge-button').addEventListener('click',async(e)=>{const b=e.target;b.disabled=true;const s=document.getElementById('validation-status');setStatus(s,'');const a=parseFloat(b.dataset.amount);const r=b.dataset.serial;if(isNaN(a)||!r){alert("An internal error occurred. Please try again.");await showView('wallet-view');return;}try{setStatus(s,'Recording banknote on public ledger...','info');await SupabaseLedger.recordSpentIdentifier(r,'banknote');setStatus(s,'Creating public transaction record...','info');const c={type:'AURA_PAYMENT_CONFIRMATION',senderAddress:'BANKNOTE_ISSUER',receiverAddress:state.wallet.address,amount:a,linkedTxHash:'charge-'+r};await SupabaseLedger.pinConfirmation(c);WalletLogic.addToChain({type:'charge',amount:a,from:'BANKNOTE_ISSUER',to:state.wallet.address,serial:r,status:'completed',linkedTxHash:'charge-'+r});CacheManager.invalidate(state.wallet.address);await BackgroundSync.performSync();alert(`$${a.toFixed(2)} added to your balance successfully.`);await showView('wallet-view');}catch(err){console.error("Charge confirmation failed:",err);setStatus(s,`Charge Failed: ${err.message}`,'error');b.disabled=false;}});document.getElementById('banknote-image-input').addEventListener('change',async(e)=>{const f=e.target.files[0];const s=document.getElementById('validation-status');if(!f)return;const a=['image/jpeg','image/png','image/webp'];if(!a.includes(f.type)){setStatus(s,'Invalid file type. Please upload a JPEG, PNG, or WebP file.','error');e.target.value='';return;}const c=document.getElementById('charge-confirmation'),b=document.getElementById('confirm-charge-button');c.style.display='none';b.disabled=true;setStatus(s,'Preparing image...','info');let p,i={};try{const r=await CoreLogic.Utils.resizeImage(f,CoreLogic.Constants.MAX_IMAGE_DIMENSION);const o=await CoreLogic.Utils.preprocessImage(r);const d=await new Promise((rs,rj)=>{const m=new Image();m.onload=()=>{const c=document.createElement('canvas');c.width=m.width;c.height=m.height;const x=c.getContext('2d');x.drawImage(m,0,0);rs(x.getImageData(0,0,m.width,m.height));};m.onerror=rj;m.src=o;});p=await CoreLogic.Banknote.decodeQrGrid(d,s);const l=pako.inflate(new Uint8Array(atob(p).split('').map(c=>c.charCodeAt(0))));const j=new TextDecoder('utf-8').decode(l);const q=JSON.parse(j);i={amount:q.a,serial:q.s};setStatus(s,'Scan complete. Contacting server for validation...','info');const v=await SupabaseLedger.validateBanknote(p);if(v.success){setStatus(s,'Banknote is valid! This is an original, unredeemed note.','success');SecurityUtils.setTextContent(document.getElementById('validated-amount'),`$${v.amount.toFixed(2)}`);b.dataset.amount=v.amount;b.dataset.serial=v.serial;b.disabled=false;c.style.display='block';}else{throw new Error("Server rejected the banknote for an unknown reason.");}}catch(err){if(err.message.includes('already been spent')&&i.serial){setStatus(s,'This banknote has a history. Fetching details...','info');try{const d=await SupabaseLedger.getSpendDetails(i.serial);const t=new Date(d.redeemedAt).toLocaleString('en-US',{dateStyle:'long',timeStyle:'medium'});s.className='status-box';const h=`<div style="text-align: left; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9;"><h4 style="text-align: center; margin-top: 0;">Banknote Certificate</h4><p><strong>Serial:</strong> <span></span></p><p><strong>Amount:</strong> $${SecurityUtils.sanitizeNumeric(i.amount).toFixed(2)}</p><hr><p style="color: #d9534f;"><strong>Status:</strong> Redeemed</p><p><strong>Redeemed By:</strong> <span></span></p><p><strong>Redeemed On:</strong> <span></span></p></div>`;SecurityUtils.setHTMLContent(s,h,['div','h4','p','strong','span','hr']);SecurityUtils.setTextContent(s.querySelector('p:nth-of-type(1) span'),i.serial);SecurityUtils.setTextContent(s.querySelector('p:nth-of-type(4) span'),d.redeemedBy||'N/A');SecurityUtils.setTextContent(s.querySelector('p:nth-of-type(5) span'),t);}catch(de){setStatus(s,`Validation Failed: This banknote was already spent, but its history could not be retrieved.`,'error');}}else{setStatus(s,`Validation Failed: ${SecurityUtils.sanitizeText(err.message)}`,'error');}}finally{e.target.value='';}});
        }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
