<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù…Ø¶Ø§ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡: Ed25519 + Falcon-512 + SHAKE256</title>
  <script src="js/Ed25519.js"></script>
  <script src="js/Shake256.js"></script>
  <script src="js/falcon.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; direction: rtl; max-width: 800px; margin: auto; }
    textarea, input { width: 100%; padding: 10px; margin-top: 10px; }
    button { padding: 10px 20px; margin-top: 10px; }
    .output { background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 5px; word-break: break-word; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Ø§Ù…Ø¶Ø§ Ø¨Ø§ Ed25519 + Falcon-512 + SHAKE256</h2>

  <div id="initStatus">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§...</div>

  <textarea id="message" rows="5" placeholder="Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
  <button onclick="signMessage()">ğŸ–‹ Ø§Ù…Ø¶Ø§</button>

  <div class="output">
    <strong>Ø§Ù…Ø¶Ø§ÛŒ Ed25519 (base64):</strong>
    <div id="ed25519Sig"></div>
    <strong>Ø§Ù…Ø¶Ø§ÛŒ Falcon-512 (base64):</strong>
    <div id="falconSig"></div>
  </div>

  <button onclick="verifySignature()">âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±</button>
  <div class="output" id="verifyResult"></div>

  <script>
    let falcon, falconKeyPair;
    let ed25519KeyPair;
    let modulesLoaded = {
      ed25519: false,
      falcon: false,
      shake: false
    };

    function shake256_1024(input) {
      try {
        const hashHex = sha3.shake256(input, 1024);
        modulesLoaded.shake = true;
        return new Uint8Array(hashHex.match(/.{1,2}/g).map(h => parseInt(h, 16)));
      } catch (e) {
        console.error('SHAKE256 Ø®Ø·Ø§:', e);
        modulesLoaded.shake = false;
        return null;
      }
    }

    async function initModules() {
      try {
        ed25519KeyPair = nacl.sign.keyPair();
        modulesLoaded.ed25519 = true;
      } catch (e) {
        console.error('Ed25519 Ø®Ø·Ø§:', e);
        modulesLoaded.ed25519 = false;
      }

      try {
        falcon = await pqcSignFalcon512();
        falconKeyPair = await falcon.generateKeyPair();
        modulesLoaded.falcon = true;
      } catch (e) {
        console.error('Falcon-512 Ø®Ø·Ø§:', e);
        modulesLoaded.falcon = false;
      }

      updateStatus();
    }

    function updateStatus() {
      const status = document.getElementById('initStatus');
      if (modulesLoaded.ed25519 && modulesLoaded.falcon && modulesLoaded.shake) {
        status.textContent = 'âœ… Ù‡Ù…Ù‡ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.';
      } else {
        status.innerHTML = '<span class=\"error\">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…â€ŒÙ‡Ø§. Ø¨Ø±Ø®ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´ÙˆØ¯.</span>';
      }
    }

    async function signMessage() {
      const msg = document.getElementById('message').value;
      const hash = shake256_1024(msg);
      if (!hash) return alert('Ø®Ø·Ø§ Ø¯Ø± Ù‡Ø´ Ø¨Ø§ SHAKE256');

      if (modulesLoaded.ed25519) {
        const sig = nacl.sign.detached(hash, ed25519KeyPair.secretKey);
        document.getElementById('ed25519Sig').textContent = btoa(String.fromCharCode(...sig));
        window._edSig = sig;
      } else {
        document.getElementById('ed25519Sig').textContent = 'âŒ Ed25519 Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯';
      }

      if (modulesLoaded.falcon) {
        const sig = await falcon.sign(falconKeyPair.privateKey, hash);
        document.getElementById('falconSig').textContent = btoa(String.fromCharCode(...sig));
        window._falSig = sig;
      } else {
        document.getElementById('falconSig').textContent = 'âŒ Falcon Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯';
      }

      window._hash = hash;
    }

    async function verifySignature() {
      let results = '';
      if (modulesLoaded.ed25519) {
        const valid = nacl.sign.detached.verify(window._hash, window._edSig, ed25519KeyPair.publicKey);
        results += `Ed25519: ${valid ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}<br>`;
      } else {
        results += 'âŒ Ed25519 Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª<br>';
      }

      if (modulesLoaded.falcon) {
        const valid = await falcon.verify(falconKeyPair.publicKey, window._hash, window._falSig);
        results += `Falcon-512: ${valid ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}`;
      } else {
        results += 'âŒ Falcon-512 Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
      }

      document.getElementById('verifyResult').innerHTML = results;
    }

    initModules();
  </script>
</body>
</html>
